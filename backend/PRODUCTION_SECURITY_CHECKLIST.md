# 本番環境セキュリティチェックリスト

## デプロイ前の必須確認事項

### 1. 環境変数とシークレット管理
- [ ] AWS Secrets Manager にすべての認証情報が設定されている
  - [ ] `pfwise-api/credentials` - API認証情報
  - [ ] `pfwise-api/google-oauth` - Google OAuth設定
  - [ ] `pfwise-api/external-apis` - 外部API認証情報
- [ ] 本番環境用の環境変数が設定されている
  - [ ] `ADMIN_IP_WHITELIST` - 管理者APIアクセス許可IPリスト
  - [ ] `DOMAIN_NAME` - 本番ドメイン名
- [ ] ハードコードされた認証情報がない

### 2. アクセス制御
- [ ] 管理者APIエンドポイントにIP制限が設定されている
- [ ] CORS設定が本番ドメインのみを許可している
- [ ] レート制限が有効化されている
  - 1分間に60リクエスト
  - 1日10,000リクエスト
  - 月間200,000リクエスト

### 3. セキュリティヘッダー
- [ ] すべてのレスポンスに以下のヘッダーが含まれる
  - [ ] `Strict-Transport-Security`
  - [ ] `X-Content-Type-Options: nosniff`
  - [ ] `X-Frame-Options: DENY`
  - [ ] `X-XSS-Protection: 1; mode=block`
  - [ ] `Content-Security-Policy`
  - [ ] `Referrer-Policy: strict-origin-when-cross-origin`

### 4. ログとモニタリング
- [ ] ログレベルが本番用に設定されている（`warn`）
- [ ] 監査ログが有効化されている
- [ ] CloudWatch アラームが設定されている
  - [ ] エラー率の監視
  - [ ] レート制限違反の監視
  - [ ] 予算超過の監視

### 5. データ保護
- [ ] すべての通信がHTTPS経由
- [ ] セッションCookieが`Secure`フラグ付き
- [ ] セッションタイムアウトが1時間に設定
- [ ] ログに機密情報が含まれていない

### 6. 依存関係
- [ ] `npm audit` で脆弱性がない
- [ ] 不要な開発用パッケージが本番環境に含まれていない
- [ ] Lambda関数のサイズが最適化されている

### 7. エラーハンドリング
- [ ] エラーレスポンスに機密情報が含まれていない
- [ ] スタックトレースが本番環境で表示されない
- [ ] 適切なエラーコードとメッセージが返される

### 8. AWS設定
- [ ] Lambda関数の予約同時実行数が設定されている（100）
- [ ] CloudWatch Logsの保持期間が30日に設定されている
- [ ] DynamoDBのバックアップが有効化されている
- [ ] IAMロールが最小権限の原則に従っている

## デプロイ後の確認事項

### 1. 機能テスト
- [ ] APIエンドポイントが正常に応答する
- [ ] 認証フローが正常に動作する
- [ ] Google Drive連携が動作する
- [ ] 市場データ取得が動作する

### 2. セキュリティテスト
- [ ] 管理者APIへの不正アクセスがブロックされる
- [ ] レート制限が正しく機能する
- [ ] 不正なOriginからのリクエストが拒否される
- [ ] SQLインジェクション対策が機能する

### 3. パフォーマンステスト
- [ ] APIレスポンスタイムが許容範囲内
- [ ] キャッシュが正しく機能している
- [ ] 同時接続数の制限が適切

### 4. 監視設定
- [ ] CloudWatch ダッシュボードが設定されている
- [ ] アラート通知が正しく送信される
- [ ] ログが正しく記録されている

## 緊急時対応

### ロールバック手順
1. 前バージョンのデプロイメントを確認
   ```bash
   npx serverless@3.32.2 rollback --stage prod
   ```

2. 特定バージョンへのロールバック
   ```bash
   npx serverless@3.32.2 rollback --stage prod --timestamp <timestamp>
   ```

### インシデント対応
1. 影響範囲の特定
2. 一時的な制限の実施（必要に応じて）
3. 原因調査とログ分析
4. 修正と再デプロイ
5. 事後レビューの実施

## 連絡先
- セキュリティインシデント: security@portfolio-wise.com
- 技術サポート: support@portfolio-wise.com