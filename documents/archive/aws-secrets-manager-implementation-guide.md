# AWS Secrets Managerå®Ÿè£…ã‚¬ã‚¤ãƒ‰

## æ¦‚è¦

Googleèªè¨¼æ©Ÿèƒ½ã«AWS Secrets Managerã‚’çµ±åˆã—ã€ã‚»ã‚­ãƒ¥ã‚¢ãªèªè¨¼æƒ…å ±ç®¡ç†ã‚’å®Ÿç¾ã™ã‚‹ãŸã‚ã®å®Œå…¨ã‚¬ã‚¤ãƒ‰ã€‚

## å®Ÿè£…çŠ¶æ³

### 1. å®Œäº†ã—ãŸä½œæ¥­

1. **Secrets Managerã¸ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆä½œæˆ**
   ```bash
   aws secretsmanager update-secret \
     --secret-id pfwise-api/google-oauth \
     --secret-string '{"GOOGLE_CLIENT_ID":"...", "GOOGLE_CLIENT_SECRET":"..."}' \
     --region us-west-2
   ```

2. **èªè¨¼ãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®å®Ÿè£…**
   - `googleAuthHandler.js` - Secrets Managerçµ±åˆç‰ˆï¼ˆä¾å­˜é–¢ä¿‚ã‚¨ãƒ©ãƒ¼ï¼‰
   - `googleAuthHandlerLite.js` - è»½é‡ç‰ˆï¼ˆç’°å¢ƒå¤‰æ•°ä½¿ç”¨ã€å‹•ä½œç¢ºèªæ¸ˆã¿ï¼‰

3. **IAMæ¨©é™ã®è¨­å®š**
   ```yaml
   - Effect: Allow
     Action:
       - secretsmanager:GetSecretValue
     Resource: 
       - !Sub 'arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:pfwise-api/google-oauth-*'
   ```

### 2. é­é‡ã—ãŸå•é¡Œ

#### AWS SDK v3ã®ä¾å­˜é–¢ä¿‚å•é¡Œ

ãƒ¢ãƒãƒ¬ãƒæ§‹é€ ã«ã‚ˆã‚Šã€ä»¥ä¸‹ã®ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ãŒLambdaãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã«å«ã¾ã‚Œãªã„ï¼š
- `@smithy/util-base64`
- `@smithy/util-buffer-from`
- ãã®ä»–ã®AWS SDKå†…éƒ¨ä¾å­˜é–¢ä¿‚

### 3. è§£æ±ºç­–

#### çŸ­æœŸçš„è§£æ±ºç­–ï¼ˆå®Ÿè£…æ¸ˆã¿ï¼‰

1. **è»½é‡ç‰ˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ã®ä½¿ç”¨**
   - Secrets Managerä¾å­˜ã‚’ä¸€æ™‚çš„ã«å›é¿
   - ç’°å¢ƒå¤‰æ•°ã‹ã‚‰èªè¨¼æƒ…å ±ã‚’å–å¾—
   - å‹•ä½œç¢ºèªæ¸ˆã¿

2. **ç’°å¢ƒå¤‰æ•°ã§ã®èªè¨¼æƒ…å ±ç®¡ç†**
   ```bash
   GOOGLE_CLIENT_SECRET=your-secret npm run deploy:prod
   ```

#### é•·æœŸçš„è§£æ±ºç­–ï¼ˆæ¨å¥¨ï¼‰

1. **Webpackçµ±åˆ**
   ```javascript
   // webpack.config.js
   module.exports = {
     mode: 'production',
     entry: './src/function/auth/googleAuthHandler.js',
     target: 'node',
     externals: {
       'aws-sdk': 'aws-sdk'
     },
     optimization: {
       minimize: true
     }
   };
   ```

2. **serverless-webpack plugin**
   ```yaml
   plugins:
     - serverless-webpack
     - serverless-dotenv-plugin
   
   custom:
     webpack:
       webpackConfig: './webpack.config.js'
       includeModules: true
       packager: 'npm'
       excludeFiles: '**/*.test.js'
   ```

3. **å€‹åˆ¥ã®ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«**
   ```json
   // backend/package.json
   {
     "dependencies": {
       "@smithy/util-base64": "^3.0.0",
       "@smithy/util-buffer-from": "^3.0.0"
     }
   }
   ```

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹

### 1. Secrets Managerã®åˆ©ç‚¹

- **é›†ä¸­ç®¡ç†**: ã™ã¹ã¦ã®ç’°å¢ƒã§åŒã˜ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚’ä½¿ç”¨
- **è‡ªå‹•ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³**: å®šæœŸçš„ãªèªè¨¼æƒ…å ±ã®æ›´æ–°
- **ç›£æŸ»è¨¼è·¡**: ã‚¢ã‚¯ã‚»ã‚¹ãƒ­ã‚°ã®è¨˜éŒ²
- **æš—å·åŒ–**: ä¿å­˜æ™‚ã®è‡ªå‹•æš—å·åŒ–

### 2. ç’°å¢ƒå¤‰æ•° vs Secrets Manager

| é …ç›® | ç’°å¢ƒå¤‰æ•° | Secrets Manager |
|------|----------|-----------------|
| ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ | AWS KMSã§æš—å·åŒ– | AWS KMSã§æš—å·åŒ– + ã‚¢ã‚¯ã‚»ã‚¹åˆ¶å¾¡ |
| ç®¡ç†æ€§ | ãƒ‡ãƒ—ãƒ­ã‚¤ã”ã¨ã«è¨­å®š | ä¸€å…ƒç®¡ç† |
| ã‚³ã‚¹ãƒˆ | ç„¡æ–™ | æœˆé¡$0.40/ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆ |
| ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ | æ‰‹å‹• | è‡ªå‹•å¯èƒ½ |

### 3. å®Ÿè£…ä¸Šã®æ³¨æ„ç‚¹

1. **ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®æ´»ç”¨**
   - 24æ™‚é–“ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã§APIå‘¼ã³å‡ºã—ã‚’å‰Šæ¸›
   - ã‚³ã‚¹ãƒˆæœ€é©åŒ–

2. **ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°**
   - Secrets Manageréšœå®³æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
   - ç’°å¢ƒå¤‰æ•°ã¸ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å®Ÿè£…

3. **æœ€å°æ¨©é™ã®åŸå‰‡**
   - ç‰¹å®šã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã®ã¿ã‚¢ã‚¯ã‚»ã‚¹å¯èƒ½
   - ãƒªã‚½ãƒ¼ã‚¹ãƒ™ãƒ¼ã‚¹ã®ãƒãƒªã‚·ãƒ¼

## ç§»è¡Œæ‰‹é †

### Phase 1: ç¾åœ¨ã®å®Ÿè£…ï¼ˆå®Œäº†ï¼‰
- ç’°å¢ƒå¤‰æ•°ã«ã‚ˆã‚‹èªè¨¼æƒ…å ±ç®¡ç†
- googleAuthHandlerLite.jsã®ä½¿ç”¨

### Phase 2: ä¾å­˜é–¢ä¿‚è§£æ±º
1. webpackè¨­å®šã®è¿½åŠ 
2. å¿…è¦ãªãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã®æ˜ç¤ºçš„ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
3. ãƒãƒ³ãƒ‰ãƒ«ã‚µã‚¤ã‚ºã®æœ€é©åŒ–

### Phase 3: Secrets Managerçµ±åˆ
1. googleAuthHandler.jsã¸ã®åˆ‡ã‚Šæ›¿ãˆ
2. ç’°å¢ƒå¤‰æ•°ã®å‰Šé™¤
3. æœ¬ç•ªç’°å¢ƒã§ã®ãƒ†ã‚¹ãƒˆ

## ã¾ã¨ã‚

ç¾åœ¨ã®å®Ÿè£…ï¼š
- âœ… Secrets Managerã«ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆä½œæˆæ¸ˆã¿
- âœ… ç’°å¢ƒå¤‰æ•°ã«ã‚ˆã‚‹æš«å®šå®Ÿè£…ï¼ˆã‚»ã‚­ãƒ¥ã‚¢ï¼‰
- âœ… æœ¬ç•ªç’°å¢ƒã§å‹•ä½œç¢ºèªæ¸ˆã¿

ä»Šå¾Œã®æ”¹å–„ï¼š
- ğŸ“‹ webpackçµ±åˆã«ã‚ˆã‚‹ä¾å­˜é–¢ä¿‚è§£æ±º
- ğŸ“‹ Secrets Managerå®Œå…¨çµ±åˆ
- ğŸ“‹ è‡ªå‹•ãƒ­ãƒ¼ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã®è¨­å®š

ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£é¢ã§ã¯ç¾åœ¨ã®å®Ÿè£…ã§ã‚‚ååˆ†å®‰å…¨ã§ã™ãŒã€é•·æœŸçš„ã«ã¯Secrets Managerçµ±åˆã‚’æ¨å¥¨ã—ã¾ã™ã€‚