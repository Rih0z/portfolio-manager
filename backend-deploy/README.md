# ポートフォリオ マーケットデータ API

Node.js、AWS Lambda、API Gateway、DynamoDBを使用して構築された、株式（米国および日本市場）、投資信託、為替レートなどの金融市場データを取得するための堅牢で効率的なAPIです。

⚠️ **注意**: このリポジトリは公開されています。機密情報（APIキー、AWS URL等）を含むファイルは`document/message/`フォルダに保存され、`.gitignore`で除外されています。

## プロジェクト概要

ポートフォリオ マーケットデータ APIは、様々な信頼できるソースからリアルタイムおよびキャッシュされた金融データを提供します。パフォーマンス、コスト効率、および回復力を最適化しながら、信頼性の高い市場データを提供するように設計されています。

## テスト結果
- **テスト合格数**: 561/579（96.9%）
- **テストスイート**: 73
- **カバレッジ**: 74%以上（Statements）

## 特徴

- **マルチソースデータ取得**: 公式APIからデータを取得し、自動フェイルオーバーメカニズムを実装
- **インテリジェントキャッシング**: APIコールを削減し、応答時間を改善
- **バッチ処理**: 複数銘柄・為替ペアの一括取得によるAWSコスト削減
- **無料データソース優先**: Yahoo Finance2 (npm)とJPX CSVによる無料データ取得
- **Googleによる認証**: Google OAuth経由のセキュアなユーザー認証
- **Google Drive連携**: ポートフォリオデータをGoogle Driveに保存・読み込み
- **適応型レート制限**: API過剰使用を防止し、外部APIの制限を尊重
- **予算監視**: AWS無料枠内に収まるよう使用状況を追跡
- **フォールバックデータストア**: 外部ソースが利用できない場合でもデータ提供
- **包括的なエラー処理**: 情報豊富なエラーメッセージによる適切な機能低下
- **対応市場データ**:
  - 米国株
  - 日本株
  - 投資信託
  - 為替レート

## プロジェクト構成

```
src/
├── config/             # 設定ファイルと定数
├── function/           # Lambda関数ハンドラー
│   ├── admin/          # 管理者向けAPIエンドポイント
│   ├── auth/           # 認証関連のエンドポイント
│   ├── drive/          # Google Drive連携エンドポイント
├── services/           # ビジネスロジックとデータソース
│   ├── sources/        # 各種データソース実装
├── utils/              # ユーティリティ関数
```

## API機能

### マーケットデータ

- **GET /api/market-data**: 株式、投資信託、為替レートデータを取得
  - クエリパラメータ: `type`, `symbols`, `base`(為替), `target`(為替), `refresh`(キャッシュ更新)

### 認証

- **POST /auth/google/login**: Googleを使用して認証
- **GET /auth/session**: 現在のセッション情報を取得
- **POST /auth/logout**: ログアウト処理

### Google Drive OAuth認証

- **GET /auth/google/drive/initiate**: Google Drive認証フローを開始
- **GET /auth/google/drive/callback**: OAuth認証コールバック処理

### Google Drive連携

- **GET /drive/files**: Google Driveのポートフォリオファイル一覧を取得
- **GET /drive/load**: Google Driveからポートフォリオデータを読み込み
- **POST /drive/save**: Google Driveにポートフォリオデータを保存

### 管理者用エンドポイント（要APIキー）

- **GET /admin/status**: API使用状況とキャッシュ情報を取得
- **GET /admin/getBudgetStatus**: AWS予算の使用状況を取得
- **POST /admin/reset**: 使用量カウンターをリセット

### デバッグ用エンドポイント（開発環境のみ）

- **GET /debug/google-config**: Google OAuth設定の確認

## データソース

### 優先順位順（無料ソース優先）

#### 米国株
1. **Yahoo Finance2 (npm)**: 無料、APIキー不要、リアルタイム
2. **Alpha Vantage API**: APIキー必要（設定されている場合のみ）
3. **Yahoo Finance API**: 従来の実装
4. **スクレイピング**: フォールバック

#### 日本株
1. **Yahoo Finance2 (npm)**: 無料、APIキー不要
2. **JPX CSV**: 日本取引所グループ公式データ（20分遅延）
3. **スクレイピング**: Yahoo Finance Japan、Minkabu、Kabutan

#### 為替レート
1. **Yahoo Finance2 (npm)**: 無料、APIキー不要
2. **Exchange Rate API**: 従来の実装

#### 投資信託
1. **Morningstar CSV**: 公式データ

## キャッシュシステム

- DynamoDBを使用したキャッシュレイヤー
- データタイプごとにカスタマイズ可能なTTL(Time To Live)
  - 米国株: 1時間
  - 日本株: 1時間
  - 投資信託: 1時間
  - 為替レート: 1時間
- 定期的なキャッシュの予熱機能（6時間ごと）
- バッチキャッシング: 複数銘柄・為替ペアの一括取得に対応
  - 個別アイテムごとのキャッシュチェックを削減
  - DynamoDBアクセス回数を大幅に削減（70-80%削減）

## 予算管理と使用量制限

- AWS無料枠の使用状況監視
- 予算上限に近づくと警告を表示
- 上限に達した場合のキャッシュ更新制限機能

## エラーハンドリング

- 標準化されたエラーレスポンス形式
- 詳細なエラーコードとメッセージ
- フォールバックデータによる耐障害性

## 認証システム

### ユーザー認証
- Google OAuthを使用した認証
- セッションIDベースのセッション管理
- DynamoDBによるセッション保存（TTL付き）
- CookieベースのセッションID管理

### API認証
- 管理者エンドポイント: AWS API Gateway のAPIキー認証（x-api-key ヘッダー）
- 公開エンドポイント: 認証不要
- CORS設定: 特定のオリジンのみ許可（localhost:3000, localhost:3001, portfolio-wise.com）

## ロギングとアラート

- 構造化ログ出力
- エラーレベルに応じたアラート通知
- 管理者向け重要イベント通知

## 開発ガイドライン

- 環境変数による設定管理
- テスト時のモックレスポンス対応
- 再試行ロジックによる耐障害
- 無料データソースを優先的に使用
- バッチリクエストによるレート制限回避

## AWSコスト最適化

- **DynamoDB最適化**
  - バッチキャッシングによるread/write削減
  - Scan操作の削除（TTLによる自動削除を利用）
- **Lambda最適化**
  - リトライ回数削減（3回→1回）
  - スケジュール実行頻度削減（1時間→6時間）
- **CloudWatch Logs最適化**
  - 本番環境のログレベルをWARNに設定
  - 不要なデバッグログの削減
- **Secrets Manager最適化**
  - キャッシュTTLを24時間に延長
  - API呼び出し回数の削減
