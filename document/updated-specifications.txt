# ポートフォリオマネージャー 仕様書（更新版3.0）

**最終更新日時:** 2025/03/18 15:30

## 1. プロジェクト概要

「ポートフォリオマネージャー」は、資産管理を支援するWebアプリケーションです。ユーザーが保有資産と理想のポートフォリオ配分を比較・管理し、最適な資金配分のシミュレーションを実施できる環境を提供します。GoogleログインとGoogleドライブ連携機能を備え、複数デバイス間でのデータ共有をサポートします。また、ブラウザのローカルストレージを活用したデータ永続化により、アプリ利用時の利便性を向上させています。

### 1.1 主要機能
- 資産管理（保有数の小数点以下4桁対応）
- 銘柄タイプ自動判定（個別株、ETF、インデックスファンドなど）
- 年間手数料率の自動推定と計算（個別株は0%固定）
- 年間配当金の計算と配当情報の管理
- 理想ポートフォリオ配分設定
- 資金配分シミュレーション
- データインポート/エクスポート
- ブラウザローカルストレージによるデータ保持（URIエンコード+Base64による安全な暗号化）
- Google認証・Googleドライブ連携（Google Identity Services API対応）
- 市場データの自動取得（Alpha Vantageをプライマリソース、フォールバック値をバックアップとして使用）
- iOS風タブバーによるナビゲーション
- エラーバウンダリによるアプリケーション耐障害性向上

### 1.2 技術スタック
- **フロントエンド**: React.js 18.x
- **認証**: Google OAuth 2.0 (@react-oauth/google 0.11.0)
- **スタイリング**: Tailwind CSS 3.x
- **ステート管理**: React Context API
- **ルーティング**: React Router 6.x
- **データ可視化**: Recharts 2.x
- **API通信**: Axios 1.x, Fetch API
- **ユーティリティ**: Lodash 4.x, Day.js 1.x, jwt-decode 3.x
- **データ処理**: PapaParse 5.x (CSV処理)
- **UI拡張**: @headlessui/react 1.x
- **サーバーレス関数**: Netlify Functions
- **デプロイ**: Netlify
- **データ永続化**: ローカルストレージ（URIエンコード+Base64暗号化）
- **クラウド連携**: Google Drive API v3

## 2. 環境設定

### 2.1 必要なファイル
- **package.json**: 依存関係とスクリプト定義
- **tailwind.config.js**: Tailwind CSSの設定
- **postcss.config.js**: PostCSSの設定
- **netlify.toml**: Netlifyデプロイとサーバーレス関数の設定
- **.env.local**: 環境変数設定（ローカル開発用）
- **src/setupProxy.js**: プロキシ設定（API連携用）
- **src/utils/fundUtils.js**: ファンドタイプと手数料情報、配当情報のユーティリティ関数
- **public/index.html**: 基本HTMLとGoogle APIスクリプトの読み込み

### 2.2 環境変数
```
# Google OAuth認証用クライアントID
REACT_APP_GOOGLE_CLIENT_ID=<YOUR_GOOGLE_CLIENT_ID>

# Google API Key
REACT_APP_GOOGLE_API_KEY=<YOUR_GOOGLE_API_KEY>

# Alpha Vantage API
ALPHA_VANTAGE_API_KEY=<YOUR_API_KEY>
```

### 2.3 Netlify Functions設定
netlify.toml（最新版）:
```toml
[build]
  command = "CI= npm run build"
  publish = "build"
  functions = "functions"

[dev]
  command = "npm start"
  port = 3000
  targetPort = 3000
  publish = "build"
  functionsPort = 9000

# Functions へのアクセス許可設定
[[headers]]
  for = "/api/*"
    [headers.values]
    Access-Control-Allow-Origin = "*"
    Access-Control-Allow-Headers = "Content-Type, Authorization"
    Access-Control-Allow-Methods = "GET, POST, OPTIONS"

# API経由でFunctionsにアクセス
[[redirects]]
  from = "/api/*"
  to = "/.netlify/functions/:splat"
  status = 200
  force = true

# SPAのためのリダイレクト
[[redirects]]
  from = "/*"
  to = "/index.html"
  status = 200

# Functions 設定
[functions]
  directory = "functions"
  node_bundler = "esbuild"
  included_files = ["functions/**"]
```

## 3. アプリケーションの構造

### 3.1 ディレクトリ構造（更新版）
```
portfolio-manager/
├── public/
│   ├── index.html      # Google API Client Libraryスクリプト追加
│   └── favicon.ico
├── src/
│   ├── components/
│   │   ├── layout/
│   │   │   ├── Header.jsx
│   │   │   ├── TabNavigation.jsx
│   │   │   └── DataStatusBar.jsx
│   │   ├── auth/
│   │   │   ├── LoginButton.jsx
│   │   │   └── UserProfile.jsx
│   │   ├── dashboard/
│   │   │   ├── PortfolioSummary.jsx      # 配当情報の表示を追加
│   │   │   ├── PortfolioCharts.jsx
│   │   │   ├── DifferenceChart.jsx
│   │   │   └── AssetsTable.jsx           # 配当情報の列を追加
│   │   ├── settings/
│   │   │   ├── TickerSearch.jsx
│   │   │   ├── PopularTickers.jsx
│   │   │   ├── HoldingsEditor.jsx        # 配当情報の表示と編集機能を追加
│   │   │   └── AllocationEditor.jsx
│   │   ├── simulation/
│   │   │   ├── BudgetInput.jsx
│   │   │   └── SimulationResult.jsx
│   │   ├── data/
│   │   │   ├── ExportOptions.jsx
│   │   │   ├── ImportOptions.jsx
│   │   │   ├── GoogleDriveIntegration.jsx # 認証フロー改善
│   │   │   └── DataErrorRecovery.jsx      # データ修復コンポーネント
│   │   └── common/
│   │       ├── CurrencyFormat.jsx
│   │       ├── NumberInput.jsx
│   │       ├── Modal.jsx
│   │       ├── ToastNotification.jsx
│   │       ├── DataSourceBadge.jsx
│   │       └── ErrorBoundary.jsx          
│   ├── context/
│   │   ├── AuthContext.js                 # 認証フロー改善
│   │   └── PortfolioContext.js            # 配当情報の処理と暗号化強化
│   ├── hooks/
│   │   ├── useAuth.js
│   │   └── usePortfolioContext.js
│   ├── pages/
│   │   ├── Dashboard.jsx
│   │   ├── Settings.jsx
│   │   ├── Simulation.jsx
│   │   └── DataIntegration.jsx
│   ├── services/
│   │   ├── api.js                         # Google Drive API連携と配当データ取得
│   │   └── marketDataService.js           # 配当情報取得機能追加
│   ├── utils/
│   │   ├── formatters.js
│   │   └── fundUtils.js                   # 配当情報推定機能追加
│   ├── App.jsx                            
│   ├── index.js
│   ├── setupProxy.js
│   └── index.css
├── functions/
│   ├── alpha-vantage-proxy.js
│   └── mof-exchange-rate-proxy.js
├── package.json
├── tailwind.config.js
├── postcss.config.js
├── netlify.toml
└── .env.local
```

### 3.2 主要ファイルの役割（更新版）

- **App.jsx**: アプリケーションのルートコンポーネント、認証プロバイダー、ルーティング設定、エラーバウンダリ
- **context/AuthContext.js**: Google認証管理、PortfolioContextとの連携、認証フロー改善
- **context/PortfolioContext.js**: ポートフォリオ状態・ロジック管理、配当情報処理、暗号化/復号化処理強化
- **hooks/useAuth.js**: 認証状態管理フック
- **hooks/usePortfolioContext.js**: ポートフォリオコンテキスト使用フック
- **utils/fundUtils.js**: ファンドタイプ判定、手数料率推定、配当情報推定のユーティリティ関数
- **setupProxy.js**: 開発環境用APIプロキシ設定
- **services/api.js**: 市場データ取得とGoogle Drive API連携、配当データ取得
- **services/marketDataService.js**: 銘柄データと配当情報の取得、ファンドタイプ判定
- **components/common/ErrorBoundary.jsx**: アプリケーションエラーのキャッチと表示
- **components/dashboard/PortfolioSummary.jsx**: 資産概要と配当情報サマリーの表示
- **components/dashboard/AssetsTable.jsx**: 資産詳細と配当情報の表示
- **components/settings/HoldingsEditor.jsx**: 保有資産の編集と配当情報表示
- **public/index.html**: Google API Client Libraryを読み込み

## 4. データモデル（更新版）

### 4.1 Asset（保有資産）
```typescript
interface Asset {
  id: string;
  name: string;
  ticker: string;
  exchangeMarket: string;
  price: number;
  currency: string;
  holdings: number; // 小数点以下4桁対応
  annualFee: number; // 年間手数料率（%）- 個別株は常に0%
  fundType: string; // ファンドの種類 (ETF_JP, INDEX_US, STOCK など)
  isStock: boolean; // 個別株かどうかのフラグ
  feeSource: string; // 手数料情報の出所 ('個別株', 'ティッカー固有の情報', 'ファンドタイプからの推定')
  feeIsEstimated: boolean; // 手数料情報が推定値かどうか
  region?: string; // 対象地域 ('日本', '米国', 'グローバル', '不明')
  lastUpdated?: string; // 最終更新日時
  source?: string; // データソース ('Alpha Vantage', 'Fallback')
  // 配当情報の追加
  dividendYield: number; // 配当利回り（%）
  hasDividend: boolean; // 配当があるかどうか
  dividendFrequency: string; // 配当頻度 ('monthly', 'quarterly', 'semi-annual', 'annual')
  dividendIsEstimated: boolean; // 配当情報が推定値かどうか
}
```

### 4.2 TargetAllocation（目標配分）
```typescript
interface TargetAllocation {
  id: string;
  name: string;
  ticker: string;
  targetPercentage: number;
}
```

### 4.3 SimulationResult（シミュレーション結果）
```typescript
interface SimulationResult {
  id: string;
  name: string;
  ticker: string;
  price: number;
  currency: string;
  targetPercentage: number;
  currentAmount: number;
  targetAmount: number;
  additionalAmount: number;
  additionalUnits: number; // 小数点以下4桁対応
  purchaseAmount: number;
  remark?: string;
}
```

### 4.4 FundTypes（ファンドタイプ）
```typescript
enum FundTypes {
  INDEX_JP = 'インデックス（日本）',
  INDEX_US = 'インデックス（米国）',
  INDEX_GLOBAL = 'インデックス（グローバル）',
  ACTIVE_JP = 'アクティブ（日本）',
  ACTIVE_US = 'アクティブ（米国）',
  ACTIVE_GLOBAL = 'アクティブ（グローバル）',
  ETF_JP = 'ETF（日本）',
  ETF_US = 'ETF（米国）',
  REIT_JP = 'REIT（日本）',
  REIT_US = 'REIT（米国）',
  CRYPTO = '暗号資産関連',
  BOND = '債券',
  STOCK = '個別株',
  UNKNOWN = '不明'
}
```

### 4.5 DividendFrequency（配当頻度）
```typescript
enum DividendFrequency {
  MONTHLY = 'monthly', // 毎月
  QUARTERLY = 'quarterly', // 四半期
  SEMI_ANNUAL = 'semi-annual', // 半年
  ANNUAL = 'annual', // 年1回
  UNKNOWN = 'unknown' // 不明
}
```

### 4.6 ローカルストレージデータ形式（更新版）
```typescript
interface PortfolioData {
  baseCurrency: string;
  exchangeRate: object;
  lastUpdated: string;
  currentAssets: Asset[];
  targetPortfolio: TargetAllocation[];
  additionalBudget: number;
  version: string; // データバージョン管理用
  timestamp: string; // 保存日時
}
```

## 5. データ永続化と認証連携（更新版）

### 5.1 ローカルストレージによるデータ保持（更新版）
- **データ暗号化**: URIエンコード + Base64エンコーディングによる安全な暗号化
- **保存タイミング**: 
  - ユーザーアクションによるデータ変更時（自動保存）
  - 明示的な保存操作時
  - Google Driveとの同期時
- **読み込みタイミング**:
  - アプリケーション初期化時
  - ユーザーによる明示的な読み込み操作時
- **フォールバック処理**: 新形式で復号化に失敗した場合、古い形式での復号化を試行
- **データ構造検証**: 復号化後のデータ構造を検証し、有効性を確認

```javascript
// 改良版データ暗号化関数
const encryptData = (data) => {
  try {
    const jsonString = JSON.stringify(data);
    return btoa(encodeURIComponent(jsonString)); // URI化してからBase64エンコード
  } catch (error) {
    console.error('データの暗号化に失敗しました', error);
    return null;
  }
};

// 改良版データ復号化関数
const decryptData = (encryptedData) => {
  try {
    const jsonString = decodeURIComponent(atob(encryptedData)); // Base64デコードしてからURI復号
    const data = JSON.parse(jsonString);
    
    // 基本的なデータ構造の検証
    if (!data || typeof data !== 'object') {
      throw new Error('無効なデータ形式です');
    }
    
    // 必須フィールドの検証
    const requiredFields = ['baseCurrency', 'currentAssets', 'targetPortfolio'];
    const missingFields = requiredFields.filter(field => !(field in data));
    if (missingFields.length > 0) {
      throw new Error(`必須フィールドがありません: ${missingFields.join(', ')}`);
    }
    
    return data;
  } catch (error) {
    console.error('データの復号化に失敗しました', error);
    // フォールバック処理 - 古い形式を試行
    try {
      const jsonString = atob(encryptedData);
      return JSON.parse(jsonString);
    } catch (fallbackError) {
      console.error('フォールバック復号化も失敗しました', fallbackError);
      return null;
    }
  }
};
```

### 5.2 Google認証とデータ同期（更新版）
- **認証フロー**: Google Identity Services APIを使用した最新のOAuth 2.0認証
- **認証情報の保存**: ローカルストレージにJWTトークンを保存
- **有効期限チェック**: トークン有効期限の確認と自動ログアウト
- **コンテキスト連携**: AuthContextとPortfolioContextの相互参照
- **アクセストークン管理**: Drive API用のアクセストークンを別途管理
- **データソース管理**:
  - ログイン時: クラウドデータを優先
  - ログアウト時: ローカルデータを使用
  - データ競合時: 最新のタイムスタンプを持つデータを優先

```javascript
// Google Identity Services APIによるアクセストークン取得
async function getGoogleAccessToken() {
  return new Promise((resolve, reject) => {
    try {
      if (window.google && window.google.accounts && window.google.accounts.oauth2) {
        const tokenClient = window.google.accounts.oauth2.initTokenClient({
          client_id: GOOGLE_CLIENT_ID,
          scope: 'https://www.googleapis.com/auth/drive.file',
          callback: (tokenResponse) => {
            if (tokenResponse && tokenResponse.access_token) {
              console.log('[API] New access token acquired');
              resolve(tokenResponse.access_token);
            } else {
              console.warn('[API] No access token in response');
              resolve(null);
            }
          },
          error_callback: (error) => {
            console.error('[API] Error getting token:', error);
            reject(error);
          }
        });
        
        // トークンをリクエスト
        tokenClient.requestAccessToken({ prompt: '' });
      } else {
        console.warn('[API] Google OAuth API not available');
        resolve(null);
      }
    } catch (error) {
      console.error('[API] Error in getGoogleAccessToken:', error);
      reject(error);
    }
  });
}
```

## 6. 手数料計算と配当情報管理（更新版）

### 6.1 銘柄タイプ判定ロジック
銘柄のティッカーシンボルや名前からファンドタイプを判定する機能を実装しています：

- **個別株の判定**:
  - 日本株: 4桁+.T形式でないもの
  - 米国株: 1-5文字のティッカーで、既知のETFやファンドに該当しないもの
  - ETF、インデックスファンド、REIT、債券ファンド、暗号資産などに該当しないもの

- **ETFの判定**:
  - 日本ETF: 1から始まる4桁の数字 + .T形式（例: 1306.T）
  - 米国ETF: 既知のETFリストに含まれる、または名前にETFを含む

- **インデックスファンドの判定**:
  - 名前に「index」「インデックス」「日経」「topix」「S&P」などを含む

- **REITの判定**:
  - 名前に「REIT」「リート」「不動産投資」などを含む

### 6.2 手数料率推定ロジック
銘柄タイプに基づいて年間手数料率を推定します：

- 個別株: 常に0%（ユーザーによる変更不可）
- インデックスファンド（日本）: 0.3%
- インデックスファンド（米国）: 0.15%
- インデックスファンド（グローバル）: 0.25%
- アクティブファンド（日本）: 1.5%
- アクティブファンド（米国）: 0.75%
- アクティブファンド（グローバル）: 1.0%
- ETF（日本）: 0.22%
- ETF（米国）: 0.12%
- REIT: 0.5-0.6%
- その他: 0.5%（デフォルト値）

### 6.3 配当情報推定ロジック（新規）
銘柄タイプや名前から配当情報を推定します：

- **配当利回り推定**:
  - 既知の銘柄: データベースから正確な値を取得
  - 高配当ETF: 3.0-4.0%
  - 米国ETF: 1.5%（平均）
  - 日本ETF: 1.8%（平均）
  - 米国REITs: 4.0%（平均）
  - 日本REITs: 3.5%（平均）
  - 債券ファンド: 2.5%（平均）
  - 個別株: 0%（情報不足のため）

- **配当の有無判定**:
  - 金ETF（GLD）など一部の銘柄: 配当なし
  - 暗号資産関連: 配当なし
  - ETF、インデックスファンド、REIT、債券: 通常配当あり
  - 名前に「dividend」「配当」「yield」「income」を含む: 配当あり
  - その他: 個別判断

- **配当頻度推定**:
  - 名前に基づいて推定（「monthly」「quarterly」など）
  - デフォルト: 四半期（quarterly）

### 6.4 特定銘柄の配当情報データベース（新規）
人気のETFやファンドについては、より正確な配当情報をアプリケーション内のデータベースから取得します：

```javascript
// 特定のティッカーシンボルの配当利回り情報（％）
export const TICKER_SPECIFIC_DIVIDENDS = {
  // 米国の主要ETF
  'SPY': 1.5,   // SPDR S&P 500 ETF
  'VOO': 1.5,   // Vanguard S&P 500 ETF
  'VTI': 1.4,   // Vanguard Total Stock Market ETF
  'QQQ': 0.6,   // Invesco QQQ Trust (ナスダック100)
  'VYM': 3.2,   // Vanguard High Dividend Yield ETF
  'VEA': 3.0,   // Vanguard FTSE Developed Markets ETF
  'VNQ': 4.0,   // Vanguard Real Estate ETF
  'HDV': 3.9,   // iShares Core High Dividend ETF
  
  // 債券ETF
  'BND': 2.8,   // Vanguard Total Bond Market ETF
  'AGG': 2.7,   // iShares Core U.S. Aggregate Bond ETF
  'HYG': 5.0,   // iShares iBoxx $ High Yield Corporate Bond ETF
  'JNK': 5.2,   // SPDR Bloomberg High Yield Bond ETF
};
```

### 6.5 年間配当金の計算（新規）
保有資産ごとの年間配当金を計算し、合計します：

```javascript
// 年間配当金の計算
const annualDividends = currentAssets.reduce((sum, asset) => {
  // 配当がない場合はスキップ
  if (!asset.hasDividend) {
    return sum;
  }
  
  let assetValue = asset.price * asset.holdings;
  
  // 通貨換算
  if (asset.currency !== baseCurrency) {
    if (baseCurrency === 'JPY' && asset.currency === 'USD') {
      assetValue *= exchangeRate.rate;
    } else if (baseCurrency === 'USD' && asset.currency === 'JPY') {
      assetValue /= exchangeRate.rate;
    }
  }
  
  return sum + (assetValue * (asset.dividendYield || 0) / 100);
}, 0);
```

## 7. 主要コンポーネントの実装詳細（更新版）

### 7.1 PortfolioSummary（更新版）
- 総資産、銘柄数、年間手数料の表示
- 年間配当金とポートフォリオ全体の配当利回りの表示（新規）
- 最高手数料率と最低手数料率の銘柄を表示
- 最高配当利回りの銘柄を表示（新規）
- ファンドタイプ別の手数料統計を表示
- ファンドタイプ別の配当金統計を表示（新規）
- 手数料と配当に関する説明を表示

### 7.2 AssetsTable（更新版）
- 保有資産の詳細テーブル表示
- 配当関連の列を追加（配当利回り、年間配当金）（新規）
- 配当頻度と配当情報源のバッジ表示（新規）
- データソースと銘柄タイプの表示
- 年間手数料の表示（個別株は0%）

### 7.3 HoldingsEditor（更新版）
- 保有資産の編集UI
- 保有数量の編集（小数点以下4桁対応）
- 配当情報の表示（配当利回り、配当頻度）（新規）
- 手数料情報の表示（読み取り専用）
- 銘柄タイプの表示
- 手数料情報の出所を表示（個別株、推定値、固有情報）
- 銘柄タイプに応じたUIの切り替え（個別株は灰色背景）

### 7.4 DataSyncStatus（更新版）
- データ同期状況の表示
- データソース（ローカル/クラウド）の表示
- 最終同期時刻の表示
- 同期ボタンの提供
- クラウド保存/読み込みボタンの提供
- エラー発生時の回復オプション表示

### 7.5 GoogleDriveIntegration（更新版）
- Googleアカウント連携UI
- Google Identity Services APIによる最新の認証フロー
- クラウドへのデータ保存機能（Fetch API使用）
- クラウドからのデータ読み込み機能
- データ同期機能（ローカルとクラウドの統合）
- 認証状態に応じたUI切り替え
- エラーハンドリングの強化

## 8. APIとデータ取得（更新版）

### 8.1 市場データ取得（更新版）
- Alpha Vantage APIを使用して最新価格を取得
- 銘柄データ取得時に銘柄タイプと手数料情報も自動推定
- 配当情報の自動推定と取得（新規）
- 個別株は手数料率0%として扱う

```javascript
// 銘柄データの取得と手数料情報、配当情報の推定
export async function fetchTickerData(ticker) {
  // Alpha Vantageから価格データを取得
  
  // ファンド情報の取得（種類と手数料率の推定）
  const fundInfo = extractFundInfo(ticker, name);
  const fundType = guessFundType(ticker, name);
  const feeInfo = estimateAnnualFee(ticker, name);
  
  // 配当情報の取得（新規）
  const dividendInfo = estimateDividendYield(ticker, name);
  const hasDividend = determineHasDividend(ticker);
  
  // 個別株かどうかを判定
  const isStock = fundType === FUND_TYPES.STOCK;
  
  // 個別株の場合は手数料を必ず0に設定
  const annualFee = isStock ? 0 : feeInfo.fee;
  
  return {
    // 銘柄データと手数料情報、配当情報
    id: ticker,
    name: name,
    ticker: ticker,
    price: price,
    currency: currency,
    holdings: 0,
    annualFee: annualFee,
    fundType: fundType,
    isStock: isStock,
    feeSource: isStock ? '個別株' : feeInfo.source,
    feeIsEstimated: isStock ? false : feeInfo.isEstimated,
    region: fundInfo.region || 'unknown',
    // 配当情報（新規）
    dividendYield: dividendInfo.yield,
    hasDividend: hasDividend,
    dividendFrequency: dividendInfo.dividendFrequency,
    dividendIsEstimated: dividendInfo.isEstimated
  };
}
```

### 8.2 配当データの取得（新規）
- 銘柄情報から配当データを自動推定
- 特定銘柄のデータベースから正確な情報を取得
- 名前とティッカーパターンに基づいて判定

```javascript
// 配当データの取得
export async function fetchDividendData(ticker) {
  try {
    // ティッカーを大文字に統一
    ticker = ticker.toUpperCase();
    
    // ファンドタイプを判定（ETFリストを優先）
    const fundType = determineFundType(ticker, ticker);
    
    // 配当情報の取得
    const dividendInfo = estimateDividendYield(ticker, ticker);
    
    // 配当情報を確定（ETFリストを優先）
    const hasDividend = determineHasDividend(ticker);
    
    return {
      success: true,
      data: {
        dividendYield: dividendInfo.yield,
        hasDividend: hasDividend,
        dividendFrequency: dividendInfo.dividendFrequency,
        dividendIsEstimated: dividendInfo.isEstimated,
        lastUpdated: new Date().toISOString()
      },
      message: '配当情報を取得しました'
    };
  } catch (error) {
    // エラー時は推定値を返す
    ...
  }
}
```

### 8.3 Google Drive API連携（更新版）
- Google Identity Services APIを使用した最新の認証フロー
- ドライブAPIへの直接アクセス（Fetch API使用）
- 適切なスコープを持つアクセストークン取得
- エラーハンドリングの強化

```javascript
// Googleドライブにデータを保存
export async function saveToGoogleDrive(data, userData, filename = 'portfolio_data.json') {
  try {
    // 新しいアクセストークンを取得
    const newToken = await getGoogleAccessToken();
    
    // メタデータとファイル内容の準備
    const metadata = {
      name: filename,
      mimeType: 'application/json'
    };
    
    // FormDataオブジェクトを作成
    const formData = new FormData();
    formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
    formData.append('file', blob);
    
    // APIリクエストを実行
    const response = await fetch(
      'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart',
      {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${newToken}` },
        body: formData
      }
    );
    
    // 結果処理
    ...
  } catch (error) {
    // エラーハンドリング
    ...
  }
}
```

### 8.4 手数料・配当情報の自動更新（更新版）
- 銘柄追加時に手数料情報と配当情報を自動取得・推定
- 市場データ更新時に手数料情報と配当情報も更新
- 手数料情報に変更があった場合は通知で表示
- 配当情報に変更があった場合は通知で表示（新規）

## 9. UI操作フロー（更新版）

### 9.1 初期化フロー（更新版）
1. アプリケーション起動
2. `PortfolioProvider` と `AuthProvider` の初期化
3. ContextConnectorによるコンテキスト間連携の確立
4. ローカルストレージからのデータ読み込み（エラーハンドリング強化）
5. トークンストレージからの認証情報読み込み
6. データがあれば状態を更新し、UIに反映
7. 配当情報が欠けている場合は初期値を設定（新規）
8. エラー発生時はエラーバウンダリでキャッチ

### 9.2 銘柄追加フロー（更新版）
1. ユーザーが銘柄シンボルを入力
2. addTicker関数を呼び出し
3. Alpha Vantage APIからデータ取得
4. 銘柄タイプを判定し、手数料情報を推定
5. 配当情報を推定（新規）
6. 個別株の場合は手数料を0%に設定
7. 保有資産と目標配分リストに追加
8. データをローカルストレージに自動保存
9. 手数料・配当情報の通知を表示

### 9.3 市場データ更新フロー（更新版）
1. ユーザーが更新ボタンをクリック
2. Alpha Vantage APIから最新価格データを取得
3. 銘柄タイプの確認と手数料情報の更新
4. 配当情報の更新（新規）
5. 手数料情報に変更があった場合は通知
6. 配当情報に変更があった場合は通知（新規）
7. データをローカルストレージに自動保存

### 9.4 データ同期フロー（更新版）
1. ユーザーが同期ボタンをクリック
2. Google Identity Services APIから新しいアクセストークンを取得
3. ローカルデータとクラウドデータを比較
4. タイムスタンプに基づいて最新データを特定
5. 最新データを状態に適用
6. 配当情報が欠けている場合は初期値を設定（新規）
7. ローカルストレージとクラウド両方にデータを保存
8. 同期状態表示の更新
9. 結果通知の表示

## 10. エラー処理と制約（更新版）

### 10.1 個別株と配当の制約（更新版）
- 個別株の年間手数料率は常に0%
- 手数料率はすべてのファンドタイプで編集不可（読み取り専用）
- 配当情報は推定値として表示（特定銘柄を除く）
- 配当データが不明な場合は「なし」として表示

### 10.2 データインポート時の処理（更新版）
- インポートしたデータ内の個別株の手数料率を0%に修正
- 銘柄タイプと手数料情報が欠けている場合は自動推定
- 配当情報が欠けている場合は初期値を設定（新規）
- インポート後にローカルストレージに自動保存

### 10.3 データ暗号化/復号化エラー対応（更新版）
- 暗号化プロセスでのエラーハンドリング強化
- 復号化失敗時のフォールバック処理
- 古い形式のデータにも対応する互換性処理
- データ構造検証による無効データの検出
- エラー詳細のログ出力と通知

## 改訂履歴
| バージョン | 日付 | 内容 | 担当者 |
|---|---|---|---|
| 1.0 | 2025/03/6 | 初版作成 |  |
| 2.0 | 2025/03/7 | 環境設定と依存関係の更新 |  |
| 3.0 | 2025/03/8 | jwt-decode対応・プロキシ設定・ESLint設定の改訂 |  |
| 4.0 | 2025/03/08 14:25 | Alpha Vantage API連携強化・環境変数名統一・データフォールバック機構拡充 |  |
| 5.0 | 2025/03/10 11:20 | 銘柄タイプ自動判定と年間手数料の自動推定機能追加 |  |
| 6.0 | 2025/03/11 13:35 | 個別株の手数料固定（0%）とファンド手数料計算ロジックの修正 |  |
| 7.0 | 2025/03/12 16:50 | 人気銘柄リストの更新 |  |
| 8.0 | 2025/03/14 09:30 | ローカルストレージによるデータ保持機能とGoogle認証連携強化 |  |
| 9.0 | 2025/03/17 14:45 | データ暗号化/復号化処理の強化、Google Drive API連携改善、エラーバウンダリ導入、認証フロー更新 |  |
| 10.0 | 2025/03/18 15:30 | 配当情報の管理機能追加、銘柄タイプ判定ロジック強化、PortfolioSummaryとAssetsTableの配当情報表示追加、Google Drive API連携の安定性向上 |  |
