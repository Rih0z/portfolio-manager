# 市場データ取得API仕様書（ETF対応とマルチ通貨機能対応版）

**最終更新日時:** 2023-05-08 14:30

## 1. 概要

この仕様書は、ポートフォリオマネージャーアプリケーションで使用する市場データ取得APIおよび関連機能について定義します。株価データと為替レートデータの取得方法、スクレイピング連携、API連携、エラーハンドリング、ETF対応機能、マルチ通貨対応について説明します。

## 2. データソース構成

### 2.1 株価データ取得方法
- **米国株**: Alpaca API（主要ソース）、Alpha Vantage API（代替ソース）
- **日本株**: スクレイピング（主要ソース）
- **投資信託**: スクレイピング（主要ソース）
- **共通バックアップ**: Yahoo Finance API（フォールバック用）、スクレイピング（最終手段）
- **一般ETF**: 特殊処理による取得（Alpaca API/Yahoo Finance API/スクレイピング）

### 2.2 為替レートデータ取得API
- **主要ソース**: exchangerate.host
- **バックアップ**: 
  - alternative-exchangerate-proxy（複数のAPIをフォールバックとして使用）
  - MOF（日本財務省）為替レート
  - Python yfinance
  - 環境変数のデフォルト値

## 3. Alpaca API（米国株）

### 3.1 概要
Alpaca Market Data APIを使用して米国株の株価データを取得します。ティックデータから日足データまで、幅広いデータを取得できます。ETF（上場投資信託）には特殊な処理が実装されています。

### 3.2 エンドポイント
- **ベースURL**: `https://data.alpaca.markets/v2`
- **最新株価取得**: `/stocks/{symbol}/quotes/latest`
- **日足データ取得**: `/stocks/{symbol}/bars?timeframe=1D&start={start}&end={end}`

### 3.3 認証
- **API Key**: `APCA-API-KEY-ID` ヘッダー
- **API Secret**: `APCA-API-SECRET-KEY` ヘッダー
- 環境変数: `ALPACA_API_KEY`, `ALPACA_API_SECRET`

### 3.4 リクエスト例
```javascript
// 最新株価の取得
const response = await axios.get(`https://data.alpaca.markets/v2/stocks/${symbol}/quotes/latest`, {
  headers: {
    'APCA-API-KEY-ID': process.env.ALPACA_API_KEY,
    'APCA-API-SECRET-KEY': process.env.ALPACA_API_SECRET
  },
  timeout: 10000
});

// 日足データの取得
const response = await axios.get(`https://data.alpaca.markets/v2/stocks/${symbol}/bars`, {
  params: {
    timeframe: '1D',
    start: '2023-03-18T00:00:00Z',
    end: '2023-03-25T00:00:00Z'
  },
  headers: {
    'APCA-API-KEY-ID': process.env.ALPACA_API_KEY,
    'APCA-API-SECRET-KEY': process.env.ALPACA_API_SECRET
  },
  timeout: 10000
});
```

### 3.5 レスポンス例
```json
// 最新株価
{
  "symbol": "AAPL",
  "quote": {
    "ap": 174.79,
    "as": 100,
    "bp": 174.77,
    "bs": 200,
    "t": "2023-03-25T14:34:12.456789Z"
  }
}

// 日足データ
{
  "bars": [
    {
      "t": "2023-03-18T00:00:00Z",
      "o": 170.22,
      "h": 174.60,
      "l": 169.95,
      "c": 172.25,
      "v": 76234500
    },
    // ...
  ],
  "symbol": "AAPL",
  "next_page_token": null
}
```

### 3.6 制限事項
- **無料プラン**: 米国株市場データのみ、リアルタイムデータなし、制限あり
- **有料プラン**: 拡張データアクセス、高頻度リクエスト許可
- **対応市場**: 米国市場のみ（日本株は対応していない）

### 3.7 ETF対応機能
Alpaca API ProxyはETF（上場投資信託）の識別と特殊処理に対応しています。ETFのタイプを自動判別し、適切な情報を提供します。

#### 3.7.1 ETFの自動識別
以下の方法でETFを識別します：
- 既知のETFリストとの照合
- 発行会社のプレフィックスパターンとの照合
- ティッカー形式の構造分析

#### 3.7.2 サポートされるETFタイプ
- 債券ETF（例: LQD, BND, AGG, TLT）
- 国際株式ETF（例: INDA, EWJ, VEA, VWO）
- 米国大型株ETF（例: SPY, VOO, IVV, VTI）
- セクターETF（例: XLF, XLE, XLK, VGT）
- テーマ型ETF（例: ARKK, ICLN, ESGU）
- レバレッジETF（例: TQQQ, UPRO, SQQQ）
- コモディティETF（例: GLD, SLV, USO）

#### 3.7.3 ETF固有の追加情報
ETFが検出された場合、以下の追加情報が返されます：
- `etfType`: ETFの種類（'bond', 'international', 'us_large_cap'など）
- `dividendYield`: 配当利回り（%）
- `hasDividend`: 配当の有無（true/false）
- `dividendFrequency`: 配当頻度（'monthly', 'quarterly'など）
- その他ETFタイプ固有のフラグ（`isBondETF`, `isIntlETF`など）

#### 3.7.4 高信頼性ETFデータ取得
ETFが検出された場合、複数のエンドポイントを順次試行し、高信頼性のデータ取得を試みます：
1. 通常のクオートエンドポイント
2. 代替バーデータエンドポイント
3. 履歴データエンドポイント
4. フォールバックデータ

## 4. 日本株スクレイピングプロキシ（日本株）

### 4.1 概要
複数の日本の金融情報サイトから日本株の株価データをスクレイピングし、統一されたフォーマットで提供します。このプロキシは複数サイトを優先順位順に試行し、最初に成功したデータを返します。

### 4.2 エンドポイント
- **ベースURL**: `/api/jp-stock-scraping-proxy`
- **パラメータ**: 
  - `code` - 証券コード（必須）

### 4.3 スクレイピング対象サイト（優先順）
1. Yahoo Finance Japan
2. Minkabu
3. Kabutan

### 4.4 リクエスト例
```javascript
// 日本株の株価取得
async function getJapaneseStockPrice(code) {
  try {
    const response = await axios.get(`/api/jp-stock-scraping-proxy`, {
      params: {
        code: code // 証券コード（4桁）
      },
      timeout: 20000
    });
    
    return response.data;
  } catch (error) {
    console.error(`日本株スクレイピングエラー: ${error.message}`);
    throw error;
  }
}
```

### 4.5 レスポンス例
```json
{
  "success": true,
  "data": {
    "ticker": "7203",
    "price": 2540,
    "name": "トヨタ自動車(株)",
    "currency": "JPY",
    "lastUpdated": "2023-03-28T05:42:12.345Z",
    "source": "Yahoo Finance Japan",
    "isStock": true,
    "isMutualFund": false
  }
}
```

### 4.6 エラーハンドリング
- すべてのソースが失敗した場合、フォールバック値を返す
- 各サイトごとにエラーは個別に捕捉し、次のソースを試行
- ネットワークエラーやタイムアウトに対応

### 4.7 ユーザーエージェントのランダム化
```javascript
function getRandomUserAgent() {
  const userAgents = [
    'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36',
    'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/16.4 Safari/605.1.15',
    'Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:123.0) Gecko/20100101 Firefox/123.0',
    'Mozilla/5.0 (X11; Linux x86_64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36',
    'Mozilla/5.0 (iPhone; CPU iPhone OS 17_4 like Mac OS X) AppleWebKit/605.1.15 (KHTML, like Gecko) Version/17.3 Mobile/15E148 Safari/604.1'
  ];
  
  return userAgents[Math.floor(Math.random() * userAgents.length)];
}
```

## 5. 投資信託スクレイピングプロキシ（投資信託）

### 5.1 概要
複数の日本の金融情報サイトから投資信託の基準価額データをスクレイピングし、統一されたフォーマットで提供します。このプロキシは複数サイトを優先順位順に試行し、最初に成功したデータを返します。

### 5.2 エンドポイント
- **ベースURL**: `/api/mutual-fund-scraping-proxy`
- **パラメータ**: 
  - `code` - ファンドコード（必須）

### 5.3 スクレイピング対象サイト（優先順）
1. Yahoo Finance Japan
2. 投資信託協会
3. Morningstar Japan
4. Minkabu

### 5.4 リクエスト例
```javascript
// 投資信託の基準価額取得
async function getMutualFundPrice(code) {
  try {
    const response = await axios.get(`/api/mutual-fund-scraping-proxy`, {
      params: {
        code: code // ファンドコード（例: 8630042C）
      },
      timeout: 20000
    });
    
    return response.data;
  } catch (error) {
    console.error(`投資信託スクレイピングエラー: ${error.message}`);
    throw error;
  }
}
```

### 5.5 レスポンス例
```json
{
  "success": true,
  "data": {
    "ticker": "8630042C",
    "price": 12500,
    "name": "ニッセイ 外国株式インデックスファンド",
    "currency": "JPY",
    "lastUpdated": "2023-03-28T05:42:12.345Z",
    "source": "投資信託協会",
    "isStock": false,
    "isMutualFund": true,
    "priceLabel": "基準価額"
  }
}
```

### 5.6 投資信託コードの正規化
```javascript
// 投資信託コードの前処理（.TとCを適切に処理）
function normalizeCode(code) {
  // .Tを取り除く
  code = code.replace(/\.T$/i, '');
  // Cを取り除く（プロキシ側で必要に応じて追加する）
  code = code.replace(/C$/i, '');
  return code;
}
```

## 6. Alpha Vantage API（追加データソース）

### 6.1 概要
Alpha Vantage APIは追加のデータソースとして使用し、Alpaca APIやYahoo Finance APIが利用できない場合のバックアップとして機能します。米国株、国際株、ETFのデータを取得できます。

### 6.2 エンドポイント
- **ベースURL**: `/api/alpha-vantage-proxy`
- **パラメータ**: 
  - `function` - 関数タイプ（必須、例：GLOBAL_QUOTE）
  - `symbol` - ティッカーシンボル（必須）

### 6.3 リクエスト例
```javascript
// Alpha Vantage APIを使用した株価取得
async function getStockPriceFromAlphaVantage(symbol) {
  try {
    const response = await axios.get(`/api/alpha-vantage-proxy`, {
      params: {
        function: 'GLOBAL_QUOTE',
        symbol: symbol
      },
      timeout: 10000
    });
    
    return response.data;
  } catch (error) {
    console.error(`Alpha Vantage APIエラー: ${error.message}`);
    throw error;
  }
}
```

### 6.4 レスポンス例
```json
{
  "Global Quote": {
    "01. symbol": "AAPL",
    "02. open": "174.19",
    "03. high": "175.10",
    "04. low": "173.35",
    "05. price": "174.72",
    "06. volume": "58427361",
    "07. latest trading day": "2023-03-28",
    "08. previous close": "173.97",
    "09. change": "0.75",
    "10. change percent": "0.4331%"
  }
}
```

### 6.5 エラーハンドリング
- APIキーの制限：Alpha Vantageは無料利用の場合、リクエスト制限が厳しいため、主にバックアップとして使用
- レート制限対応：Alpha Vantage APIのレート制限に達した場合は適切にエラーハンドリング
- 通貨変換機能：日本株や国際株の場合、通貨を適切に設定

## 7. 株価スクレイピングプロキシ（バックアップ）

### 7.1 概要
API経由でのデータ取得に失敗した場合、複数の金融サイトから直接スクレイピングを試みるプロキシです。特に米国株とETFをカバーします。

### 7.2 エンドポイント
- **ベースURL**: `/api/stock-scraping-proxy`
- **パラメータ**: 
  - `symbol` - ティッカーシンボル（必須）
  - `type` - アセットタイプ（オプション、'stock'または'etf'）

### 7.3 スクレイピング対象サイト
1. Yahoo Finance
2. MarketWatch
3. Investing.com

### 7.4 リクエスト例
```javascript
// スクレイピングによる株価取得
async function getStockPriceViaScraping(symbol) {
  try {
    const response = await axios.get(`/api/stock-scraping-proxy`, {
      params: {
        symbol: symbol,
        type: 'stock' // または 'etf'
      },
      timeout: 15000
    });
    
    return response.data;
  } catch (error) {
    console.error(`スクレイピングエラー: ${error.message}`);
    throw error;
  }
}
```

### 7.5 レスポンス例
```json
{
  "success": true,
  "data": {
    "ticker": "AAPL",
    "price": 174.79,
    "name": "Apple Inc.",
    "currency": "USD",
    "lastUpdated": "2023-03-28T14:25:36.789Z",
    "source": "Yahoo Finance"
  }
}
```

## 8. Yahoo Finance API（バックアップ）

### 8.1 概要
Yahoo Finance非公式APIは、Alpaca APIやスクレイピングが利用できない場合のフォールバックとして使用します。米国株、日本株、投資信託のすべてをカバーしています。

### 8.2 エンドポイント
- **ベースURL**: `https://query1.finance.yahoo.com/v7/finance/quote`
- **パラメータ**: `symbols=AAPL,MSFT,7203.T,8630042C.T` (カンマ区切りで複数銘柄指定可能)

### 8.3 認証
- 認証不要（パブリックAPI）
- ただし、大量リクエストはブロックされる可能性あり

### 8.4 リクエスト例
```javascript
// 複数銘柄の例（米国株と日本株・投資信託を混在可能）
const response = await axios.get('https://query1.finance.yahoo.com/v7/finance/quote', {
  params: { symbols: 'AAPL,MSFT,7203.T,8630042C.T' },
  headers: {
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
  },
  timeout: 15000
});
```

### 8.5 レスポンス例
```json
{
  "quoteResponse": {
    "result": [
      {
        "symbol": "AAPL",
        "shortName": "Apple Inc.",
        "regularMarketPrice": 174.79,
        "currency": "USD"
      },
      {
        "symbol": "7203.T",
        "shortName": "トヨタ自動車(株)",
        "regularMarketPrice": 2540,
        "currency": "JPY"
      },
      {
        "symbol": "8630042C.T",
        "shortName": "ニッセイ 外国株式インデックスファンド",
        "regularMarketPrice": 12500,
        "currency": "JPY"
      }
    ],
    "error": null
  }
}
```

### 8.6 日本株・投資信託のティッカー形式
- 日本株: 証券コードの後に `.T` を付加（例: `7203.T`）
- 投資信託: ファンドコードの後に `C.T` を付加（例: `8630042C.T`）
- 自動変換関数を実装
```javascript
function formatTickerForYahoo(ticker) {
  // 投資信託コード（7〜8桁の数字）の場合
  if (/^\d{7,8}$/.test(ticker)) {
    return `${ticker}C.T`;
  }
  // 投資信託コード（末尾にCがある）の場合
  else if (/^\d{7,8}C$/.test(ticker)) {
    return `${ticker}.T`;
  }
  // 4桁の数字のみの場合は.Tを付加（日本株）
  else if (/^\d{4}$/.test(ticker)) {
    return `${ticker}.T`;
  }
  return ticker;
}
```

### 8.7 専用ETF処理機能
Yahoo Finance Proxyには、ETF（上場投資信託）専用の拡張処理機能が実装されています。

#### 8.7.1 ETF専用エンドポイント
ETF特有の詳細情報を取得するために異なるYahoo Financeエンドポイントを使用します：
```javascript
const etfUrl = `https://query2.finance.yahoo.com/v10/finance/quoteSummary/${symbol}?modules=price,defaultKeyStatistics,summaryDetail`;
```

#### 8.7.2 ETF特有のレスポンスフィールド
```json
{
  "ticker": "SPY",
  "price": 540.00,
  "name": "SPDR S&P 500 ETF Trust",
  "currency": "USD",
  "lastUpdated": "2023-05-07T12:34:56.789Z",
  "source": "Yahoo Finance (US Large Cap ETF)",
  "isStock": false,
  "isMutualFund": false,
  "isETF": true,
  "etfType": "us_large_cap",
  "isUSETF": true,
  "priceLabel": "株価",
  "dividendYield": 1.5,
  "hasDividend": true,
  "dividendFrequency": "quarterly"
}
```

#### 8.7.3 ETFタイプの自動判別
ETFのティッカーシンボルを分析し、以下のタイプに自動分類します：
- 債券ETF: `bond`
- 国際株ETF: `international`
- 米国大型株ETF: `us_large_cap`
- セクターETF: `sector`
- テーマ型ETF: `thematic`
- レバレッジETF: `leveraged`
- コモディティETF: `commodity`

## 9. exchangerate.host（為替レート取得）

### 9.1 概要
exchangerate.hostは無料で為替レートデータを提供するAPIです。USD/JPYなどの通貨ペアのレートを取得できます。

### 9.2 エンドポイント
- **ベースURL**: `https://api.exchangerate.host/latest`
- **パラメータ**: 
  - `base=USD` (基準通貨)
  - `symbols=JPY` (対象通貨)

### 9.3 認証
- 認証不要（パブリックAPI）

### 9.4 リクエスト例
```javascript
const response = await axios.get('https://api.exchangerate.host/latest', {
  params: {
    base: 'USD',
    symbols: 'JPY'
  },
  timeout: 5000
});
```

### 9.5 レスポンス例
```json
{
  "success": true,
  "timestamp": 1618295587,
  "base": "USD",
  "date": "2021-04-12",
  "rates": {
    "JPY": 109.64
  }
}
```

### 9.6 フォールバック処理
- API障害時は環境変数 `DEFAULT_EXCHANGE_RATE` の値（デフォルト: 150.0）を使用

## 10. 代替為替レートソース

### 10.1 概要
exchangerate.hostが利用できない場合のバックアップとして、複数の代替ソースを使用します。

### 10.2 代替ソースリスト
1. openexchangerates.org
2. fixer.io
3. 日本財務省（MOF）為替レート
4. ハードコードされたデフォルト値
5. Python yfinance

### 10.3 エンドポイント
- **ベースURL**: `/api/alternative-exchangerate-proxy`
- **パラメータ**: 
  - `base` - 基準通貨（例: 'USD'）
  - `symbols` - 対象通貨（例: 'JPY'）

### 10.4 リクエスト例
```javascript
// 代替ソースを使用した為替レート取得
async function getExchangeRateFromAlternativeSource(base, symbols) {
  try {
    const response = await axios.get(`/api/alternative-exchangerate-proxy`, {
      params: {
        base: base,
        symbols: symbols
      },
      timeout: 10000
    });
    
    return response.data;
  } catch (error) {
    console.error(`代替為替レートソースエラー: ${error.message}`);
    throw error;
  }
}
```

### 10.5 レスポンス例
```json
{
  "success": true,
  "data": {
    "rate": 150.25,
    "source": "openexchangerates.org",
    "base": "USD",
    "currency": "JPY",
    "timestamp": "2023-03-28T10:30:45.678Z"
  }
}
```

## 11. Python yfinance連携

### 11.1 概要
`yfinance-proxy.js`は、Pythonのyfinanceライブラリを子プロセスとして実行し、株価データと為替レートデータを取得するためのプロキシ機能を提供します。この機能は他のデータソースがエラーや遅延を起こした場合のバックアップとして使用できます。

### 11.2 エンドポイント
- **ベースURL**: `/api/yfinance-proxy`
- **メソッド**: GET
- **パラメータ**: 
  - `symbols` - カンマ区切りのティッカーシンボル（例: 'AAPL,MSFT,7203.T'）
  - `exchange_rate` - 通貨ペア（例: 'USDJPY'）

### 11.3 リクエスト例
```javascript
// 株価データの取得
async function fetchStockData(symbols) {
  try {
    const response = await axios.get(`/api/yfinance-proxy`, {
      params: { symbols: symbols }
    });
    
    return response.data;
  } catch (error) {
    console.error(`yfinance APIエラー: ${error.message}`);
    throw error;
  }
}

// 為替レートの取得
async function fetchExchangeRate(fromCurrency, toCurrency) {
  try {
    const response = await axios.get(`/api/yfinance-proxy`, {
      params: { exchange_rate: `${fromCurrency}${toCurrency}` }
    });
    
    return response.data;
  } catch (error) {
    console.error(`yfinance APIエラー: ${error.message}`);
    throw error;
  }
}
```

### 11.4 レスポンス例（株価データ）
```json
{
  "success": true,
  "data": {
    "AAPL": {
      "ticker": "AAPL",
      "price": 176.82,
      "name": "Apple Inc.",
      "currency": "USD",
      "lastUpdated": "2023-05-07T12:34:56.789Z"
    },
    "7203.T": {
      "ticker": "7203.T",
      "price": 2540,
      "name": "トヨタ自動車(株)",
      "currency": "JPY",
      "lastUpdated": "2023-05-07T12:34:56.789Z"
    }
  }
}
```

### 11.5 レスポンス例（為替レート）
```json
{
  "success": true,
  "rate": 150.25,
  "source": "Python yfinance",
  "lastUpdated": "2023-05-07T12:34:56.789Z"
}
```

### 11.6 技術的詳細
このAPIは以下の技術を使用しています：
- **Python**: バックエンドでPythonスクリプトを実行
- **yfinance**: 株価データと為替レートを取得するPythonライブラリ
- **pandas**: データ処理用のPythonライブラリ

### 11.7 依存関係
以下のPythonパッケージが必要です（`requirements.txt`）：
```
yfinance==0.2.35
pandas==2.1.0
numpy==1.25.0
pytz==2023.3
```

## 12. API連携実装（サーバーレス関数）

プロジェクトには、以下のサーバーレス関数が実装されています：

1. **alpaca-api-proxy.js**: Alpaca APIを使用して米国株とETFのデータを取得
2. **alpha-vantage-proxy.js**: Alpha Vantage APIを使用して株価データを取得
3. **exchangerate-proxy.js**: exchangerate.hostを使用して為替レートを取得
4. **alternative-exchangerate-proxy.js**: 複数のソースから為替レートを取得
5. **jp-stock-scraping-proxy.js**: 日本株の株価をスクレイピングで取得
6. **mutual-fund-scraping-proxy.js**: 投資信託の基準価額をスクレイピングで取得
7. **yahoo-finance-proxy.js**: Yahoo Finance APIを使用して株価データを取得
8. **yfinance-proxy.js**: Python yfinanceを使用して株価データと為替レートを取得
9. **stock-scraping-proxy.js**: 複数の金融サイトから株価データをスクレイピングで取得
10. **mof-exchange-rate-proxy.js**: 日本財務省の為替レートデータを取得

各APIプロキシは適切なエラーハンドリングとフォールバックメカニズムを備えており、データの可用性を高めています。

## 13. エラーハンドリングとフォールバック

### 13.1 エラーコード別対応
- **400 Bad Request**: パラメータ不正、「銘柄パラメータが必要です」として通知
- **401/403 Unauthorized/Forbidden**: 認証エラー、「APIキーが無効です」として通知
- **404 Not Found**: 銘柄不明、「銘柄が見つかりません」として通知
- **429 Too Many Requests**: レート制限、「API使用制限に達しました」として通知
- **500 Server Error**: サーバーエラー、「APIサーバーでエラーが発生しました」として通知
- **Network Error**: 接続エラー、「ネットワーク接続に問題があります」として通知
- **Timeout**: タイムアウト、「APIからの応答がタイムアウトしました」として通知
- **スクレイピングエラー**: データ抽出失敗、「ウェブサイトからのデータ抽出に失敗しました」として通知

### 13.2 フロントエンド通知
- **成功通知**: 「市場データを更新しました: 日本株スクレイピング: X件, 投資信託スクレイピング: Y件, Alpaca: Z件」（自動消去）
- **警告通知**: 「一部データは取得できず、フォールバック値を使用しています」（自動消去）
- **エラー通知**: 「データ取得中にエラーが発生しました: [詳細エラー]」（手動消去）

### 13.3 フォールバック機構
1. 米国株はAlpaca APIで取得を試行、失敗時はAlpha Vantage APIまたはYahoo Finance APIを使用
2. 日本株はスクレイピングで取得を試行、失敗時はYahoo Finance APIを使用
3. 投資信託はスクレイピングで取得を試行、失敗時はYahoo Finance APIを使用
4. すべてのAPIが失敗した場合はスクレイピングで取得を試行
5. いずれも失敗した場合、以前保存されたデータまたはデフォルト値を使用

## 14. 環境変数

```
# Alpaca API（米国株取得用）
ALPACA_API_KEY=あなたのAPIキー
ALPACA_API_SECRET=あなたのAPIシークレット

# Alpha Vantage API
ALPHA_VANTAGE_API_KEY=あなたのAPIキー

# 代替為替レートソース
OPEN_EXCHANGE_RATES_APP_ID=あなたのAPP ID
FIXER_API_KEY=あなたのAPIキー

# スクレイピングのタイムアウト設定
JP_STOCK_SCRAPING_TIMEOUT=20000
MUTUAL_FUND_SCRAPING_TIMEOUT=20000

# デフォルト為替レート（API障害時のフォールバック用）
DEFAULT_EXCHANGE_RATE=150.0
```

## 15. 為替レート管理機能

### 15.1 複数通貨対応
- 為替レートを使用して円⇔ドルの通貨換算を行う機能
- 現在の為替レートに基づいた正確な通貨換算

### 15.2 為替レート取得ロジック
- **主要ソース**: exchangerate.host API
- **セカンダリソース**: alternative-exchangerate-proxy（複数のAPIをフォールバックとして使用）
- **バックアップ**: ハードコードされたデフォルト値

### 15.3 為替レートの表示
- レート値の表示（例: 150.0円/ドル）
- レートソースの表示（例: exchangerate.host, Fallback）
- 最終更新日時の表示

### 15.4 通貨変換関数
```javascript
// 通貨変換関数
function convertCurrency(amount, fromCurrency, toCurrency, exchangeRate) {
  if (fromCurrency === toCurrency) {
    return amount;
  }
  
  // 円→ドル
  if (fromCurrency === 'JPY' && toCurrency === 'USD') {
    return amount / exchangeRate.rate;
  }
  
  // ドル→円
  if (fromCurrency === 'USD' && toCurrency === 'JPY') {
    return amount * exchangeRate.rate;
  }
  
  throw new Error(`Unsupported currency conversion: ${fromCurrency} to ${toCurrency}`);
}
```

## 16. AIプロンプト生成

### 16.1 概要
アプリケーションでは、ポートフォリオデータを外部AIアシスタント（Claude、ChatGPT、Geminiなど）に送信するための構造化プロンプトを生成する機能を提供します。この機能は、ユーザーがポートフォリオ分析のためにAIアシスタントを活用できるようサポートします。

### 16.2 プロンプト生成の目的
- ポートフォリオデータを構造化された形式でAIアシスタントに提供
- 分析の質を高めるためのガイドラインを含める
- 一貫性のある分析結果を得るための標準フォーマットを提供

### 16.3 プロンプト構成
- **初期情報**: 総資産額、毎月の投資予定額（対応する通貨表示）
- **現状配分**: 現在のポートフォリオ配分率（%）と銘柄名の一覧
- **目標配分**: 理想的なポートフォリオ配分率（%）と銘柄名の一覧
- **分析ガイドライン**: AIが実施すべき分析内容の詳細指示
- **出力フォーマット**: マークダウン形式での分析結果の構造指定

### 16.4 使用例
1. ユーザーがシミュレーション画面でプロンプト生成を要求
2. アプリケーションが現在のポートフォリオデータを基にプロンプトを生成
3. ユーザーがプロンプトをコピーして外部AIアシスタントに貼り付け
4. 外部AIがプロンプトに基づいてポートフォリオ分析を実施

### 16.5 プロンプト例（抜粋）
```
あなたは投資分析に特化した AI アシスタントです。
目的: ユーザーの投資ポートフォリオを分析し、最適な配分戦略と具体的な投資プランを提案すること。

### 初期情報収集
- 現在の総資産額: 1,000,000 円 (JPY)
- 毎月の新規投資予定額: 300,000 円 (JPY)

### 現状の投資ポートフォリオ構成:
- AAPL: 25.9%（Apple Inc.）
- 7203.T: 74.1%（トヨタ自動車(株)）

### 理想的と考えるポートフォリオ構成:
- AAPL: 30.0%（Apple Inc.）
- 7203.T: 40.0%（トヨタ自動車(株)）

▼ 分析ガイドライン
各銘柄について：
1. 直近の市場パフォーマンスと価格動向を調査
2. マクロ経済環境と当該資産クラスへの影響を考慮
...
```

## 17. 留意事項

### 17.1 スクレイピングの制約
- ウェブサイトの構造変更に脆弱
- サイト側の防止機構（CAPTCHA等）に対応不能
- 過度な使用によるIPブロック可能性あり
- ランダムなユーザーエージェントと適切な間隔が必要

### 17.2 倫理的・法的考慮事項
- 対象サイトの利用規約を尊重
- 商用利用に関する制限を確認
- 過度な負荷をかけない配慮
- データの正確性に関する免責事項を明記

### 17.3 通貨関連の注意点
- 為替レートは変動するため、シミュレーション結果は実際の金額と異なる可能性がある
- 為替レート取得失敗時はフォールバック値を使用するため、精度が低下する
- 通貨変換を伴う表示では、その旨をユーザーに明示する

### 17.4 AIプロンプト生成の注意点
- 生成されたプロンプトはあくまで外部AIアシスタント用のテンプレート
- 分析結果の品質は使用するAIアシスタントの能力に依存
- 個人情報や機密情報を含めないよう注意

## 改訂履歴

| バージョン | 日付 | 内容 | 担当者 |
|---|---|---|---|
| 1.0 | 2023-03-07 | 初版作成 |  |
| 2.0 | 2023-03-12 | Alpha Vantage API連携強化、環境変数名統一 |  |
| 3.0 | 2023-03-20 | Yahoo Finance APIをバックアップソースとして追加 |  |
| 4.0 | 2023-03-25 | JPX API追加、データソース別のエラーハンドリング強化 |  |
| 5.0 | 2023-03-28 | スクレイピングベースの株価取得システムに変更。日本株と投資信託のスクレイピングプロキシを追加。 |  |
| 6.0 | 2023-05-07 | ETF対応機能の詳細を追記。Python yfinance連携についての詳細を追記。AIプロンプト生成機能とマルチ通貨対応を追加。 |  |
| 7.0 | 2023-05-08 | 代替為替レートソース、株価スクレイピングプロキシ、Alpha Vantage API連携を追加。日付形式を修正。 |  |
