# ポートフォリオマネージャー インターフェース仕様書（AWS環境移行対応版）

**ファイルパス:** document/interface-specification.md  
**最終更新日時:** 2025-05-20 17:30

*本仕様書は、AIの別セッションでも開発を引き継げるよう設計されています。*

## 1. プロジェクト概要

「ポートフォリオマネージャー」は、資産管理を支援するWebアプリケーションです。ユーザーが保有資産と理想のポートフォリオ配分を比較・管理し、最適な資金配分のシミュレーションを実施できる環境を提供します。ブラウザのローカルストレージを活用したデータ永続化およびGoogleログインとGoogleドライブ連携機能を備え、複数デバイス間でのデータ共有をサポートします。

### 1.1 主要機能
- 資産管理（保有数の小数点以下4桁対応）
- 銘柄タイプ自動判定（個別株、ETF、インデックスファンド、投資信託など）
- 年間手数料率の自動推定と計算（個別株は0%固定、投資信託は信託報酬として表示）
- 年間配当金の計算と配当情報の管理
- 理想ポートフォリオ配分設定
- 複数通貨（円/ドル）対応の資金配分シミュレーション
- 購入可能株数の計算表示
- AI分析機能（ポートフォリオデータをAIアシスタントに分析させるプロンプト生成）
- データインポート/エクスポート
- ブラウザローカルストレージによるデータ永続化（URIエンコード+Base64による安全な暗号化）
- Google認証・Googleドライブ連携（バックエンドAPI経由のセキュアな認証方式）
- 市場データの自動取得（単一APIサーバーから取得）
- iOS風タブバーによるナビゲーション
- 自動消去機能付き通知システム
- エラーバウンダリによるアプリケーション耐障害性の向上

### 1.2 技術スタック
- **フロントエンド**: React.js 18.x
- **認証**: Google OAuth 2.0 認可コードフロー (@react-oauth/google 0.11.0)
- **スタイリング**: Tailwind CSS 3.x
- **ステート管理**: React Context API
- **ルーティング**: React Router 6.x
- **データ可視化**: Recharts 2.x
- **API通信**: Axios 1.x, Fetch API
- **ユーティリティ**: Lodash 4.x, Day.js 1.x
- **データ処理**: PapaParse 5.x (CSV処理)
- **UI拡張**: @headlessui/react 1.x
- **デプロイ**: AWS Amplify / Netlify
- **データ永続化**: ローカルストレージ（URIエンコード+Base64暗号化）
- **クラウド連携**: Google Drive API v3（バックエンド経由）
- **市場データ取得**: 単一の市場データAPIサーバー（`REACT_APP_MARKET_DATA_API_URL`）
- **認証セキュリティ**: HTTP-Onlyクッキーによるセッション管理
- **環境管理**: 環境固有の設定ファイル（`.env.development`、`.env.production`）

## 2. インターフェース構造

### 2.1 ページ構成
- **ダッシュボード** (`/`): 資産概要、グラフ、銘柄詳細
- **設定** (`/settings`): 銘柄追加、保有資産設定、目標配分設定、AIプロンプト設定
- **シミュレーション** (`/simulation`): 追加予算と購入シミュレーション（複数通貨対応、購入株数表示）、AI分析プロンプト
- **データ連携** (`/data`): インポート/エクスポート、データ同期、Googleドライブ連携

### 2.2 ナビゲーション
- 画面下部固定のiOS風タブナビゲーション
- 4つのタブ（ホーム、設定、シミュレーション、データ）
- アイコンとテキストの組み合わせUI
- アクティブタブの視覚的強調（青色ハイライト）
- セーフエリア対応（iPhoneのホームバーなど）

### 2.3 レイアウト構造
```
+----------------------------------------+
|              ヘッダー                  |
| (通貨切替、データ更新、ユーザープロフィール) |
+----------------------------------------+
|                                        |
|             メインコンテンツ             |
|                                        |
|                                        |
|                                        |
+----------------------------------------+
|             タブナビゲーション           |
| [ホーム] [設定] [シミュレーション] [データ] |
+----------------------------------------+
|         セーフエリア（ホームバー用）       |
+----------------------------------------+
```

### 2.4 エラーバウンダリ
- アプリケーション全体をエラーバウンダリでラップ
- 予期しないエラー発生時にアプリケーションのクラッシュを防止
- ユーザーフレンドリーなエラー表示画面
- リロードボタンによる復旧機能

### 2.5 通知システム
- 画面右下に固定表示される通知パネル
- 通知のタイプに応じた色分け表示
  - 成功：緑色背景
  - 警告：黄色背景
  - エラー：赤色背景
  - 情報：青色背景
- 自動消去機能付き
  - 情報、成功、警告通知：5秒後に自動消去
  - エラー通知：ユーザーによる手動消去が必要
- 各通知には手動で閉じるボタン（×）を表示
- 同時に複数の通知を表示可能
- スタック表示で新しい通知が下に追加される

### 2.6 データソース表示
- 銘柄データのソースを明示的に表示
  - Market Data API：青色バッジ
  - Fallback：黄色バッジ
- 更新時にデータソースの利用状況を通知
  - 例：「市場データを更新しました: Market Data API: 8件、Fallback: 2件」
- フォールバック使用時は注意喚起表示
- 株価情報の信頼性をユーザーが判断できるようサポート

## 3. 状態管理

### 3.1 コンテキスト設計
- **AuthContext**: 認証状態、ユーザー情報、Googleドライブ連携、PortfolioContextへの参照
- **PortfolioContext**: ポートフォリオデータ、資産情報、配当情報、シミュレーション計算、手数料管理、ローカルストレージ操作、AIプロンプトテンプレート

### 3.2 コンテキスト間の連携
- **ContextConnector**: AuthContextとPortfolioContextの相互参照を管理するコンポーネント
- **setPortfolioContextRef**: AuthContextがPortfolioContextへの参照を保持するための関数
- **handleAuthStateChange**: 認証状態変更時にPortfolioContextに通知するための関数

### 3.3 主要な状態変数
- `baseCurrency`: 基準通貨 ('JPY' | 'USD')
- `exchangeRate`: 為替レート情報 ({ rate, source, lastUpdated })
- `currentAssets`: 保有資産の配列（配当情報を含む）
- `targetPortfolio`: 目標配分の配列
- `additionalBudget`: 追加投資予算情報（金額と通貨）
- `aiPromptTemplate`: AI分析プロンプトのテンプレート
- `isAuthenticated`: 認証状態
- `user`: ユーザー情報
- `notifications`: 通知メッセージの配列
- `dataSource`: データソース ('local' | 'cloud')
- `lastSyncTime`: 最終同期時間
- `initialized`: 初期化完了フラグ
- `hasError`: エラー状態（エラーバウンダリ用）
- `totalAssets`: 総資産額
- `annualFees`: 年間手数料合計
- `annualDividends`: 年間配当金合計

### 3.4 データ構造
[以下、データ構造は変更なし...]

## 4. コンポーネント仕様

### 4.1 ダッシュボード画面コンポーネント
[以下、ダッシュボード画面コンポーネント仕様は変更なし...]

### 4.2 設定画面コンポーネント
[以下、設定画面コンポーネント仕様は変更なし...]

### 4.3 シミュレーション画面コンポーネント
[以下、シミュレーション画面コンポーネント仕様は変更なし...]

### 4.4 データ連携画面コンポーネント
- **ExportOptions**: データエクスポート機能
  - JSON/CSV形式選択
  - ファイルダウンロードとクリップボードコピー
  - アクセシビリティ対応済み（ラジオグループの適切な構造化）
- **ImportOptions**: データインポート機能
  - JSON/CSV形式選択
  - ファイル/クリップボード/テキスト入力による取り込み
  - アクセシビリティ対応済み
- **GoogleDriveIntegration**: Googleドライブ連携機能（バックエンド連携版、AWS環境対応）
  - ログイン状態表示
  - クラウド保存/読み込みボタン
  - データ同期ステータス表示
  - 同期ボタン
  - ファイル一覧表示と選択機能
  - バックエンドAPI経由でのファイル操作
  - 認証エラー処理
  - 環境に応じたAPIエンドポイント自動選択
  - リトライ機能付きの通信処理
- **DataErrorRecovery**: データ修復機能
  - ローカルストレージのクリア機能
  - データリセット機能
  - エラー報告表示

### 4.5 共通コンポーネント
- **Header**: アプリヘッダー（通貨切替、更新ボタン）
- **TabNavigation**: iOS風タブナビゲーション
- **LoginButton**: Googleログインボタン（認可コードフロー対応）
  - flow="auth-code" 設定
  - ローディング状態表示
  - エラーメッセージ表示
  - 環境に応じたリダイレクトURI設定
- **UserProfile**: ユーザープロフィール表示
  - プロフィール画像表示
  - ユーザー名表示
  - ログアウトボタン（バックエンドセッション終了処理）
- **ToastNotification**: 通知メッセージ表示
  - 自動消去タイマー機能（情報/成功/警告通知は5秒後に自動消去）
  - 手動消去ボタン
  - 通知タイプ別のスタイリング
- **DataSourceBadge**: データソース表示バッジ
  - 各データソースに応じた表示（Market Data API、Fallback）
  - ソースに応じた色分け
- **ErrorBoundary**: エラーバウンダリコンポーネント
  - エラー発生時の処理
  - リロード機能
  - エラー詳細表示

### 4.6 ユーティリティコンポーネント
- **FundTypeBadge**: ファンドタイプを表示するバッジ
- **FeeSourceBadge**: 手数料情報の出所を表示するバッジ
- **DividendBadge**: 配当情報を表示するバッジ
- **PriceDisplay**: 株価/基準価額を適切に表示するコンポーネント
- **ContextConnector**: コンテキスト間の連携を管理するコンポーネント

## 5. 市場データ取得システム仕様

[以下、市場データ取得システム仕様は変更なし...]

## 6. 為替レート管理機能

[以下、為替レート管理機能仕様は変更なし...]

## 7. AI分析機能

[以下、AI分析機能仕様は変更なし...]

## 8. データ永続化と同期

### 8.1 ローカルストレージ
- **データ暗号化**: URIエンコーディングを含むBase64エンコーディングによる安全な暗号化
- **保存タイミング**: 
  - 資産情報変更時
  - 目標配分変更時
  - 基本通貨変更時
  - AIプロンプトテンプレート変更時
- **バージョン管理**: データ構造のバージョンを記録し、互換性を確保
- **エラー復旧**: 破損データの検出と修復機能

### 8.2 Google Drive連携（バックエンド連携版、AWS環境対応）
- **認証**: Google OAuth 2.0認可コードフローによるセキュアな認証
  - クライアントはコードを取得、バックエンドでトークン交換
  - HTTP-Onlyクッキーによるセッション管理
  - XSS攻撃からの保護強化
  - 環境に応じた認証エンドポイント自動選択
- **ファイル操作**: 
  - バックエンドAPIを経由したGoogleドライブ操作
  - 特定フォルダへのデータ保存
  - ファイルの自動命名（アプリ名+タイムスタンプ）
  - 最新データの取得と適用
  - ファイル一覧の取得と表示
  - リトライ機能付きの通信処理
- **同期フロー**: 
  1. ユーザーがGoogleアカウントでログイン（認可コードフロー）
  2. バックエンドがGoogle APIと連携してファイル一覧を取得
  3. 最新ファイルの内容を取得
  4. ローカルデータと同期・マージ
- **セキュリティ強化**:
  - クライアントシークレットのバックエンド保管
  - リフレッシュトークンの安全な管理
  - 認証状態のサーバーサイド検証
  - CSRF保護
- **エラーハンドリング**:
  - 一時的なネットワークエラーに対するリトライ処理
  - 認証失効時の自動再認証フロー
  - ユーザーフレンドリーなエラーメッセージ表示

### 8.3 データインポート/エクスポート
- **エクスポート形式**: 
  - JSON: 完全なデータ構造を保持
  - CSV: 一部のデータのみ（互換性向上のため）
- **インポート方法**: 
  - ファイルアップロード
  - クリップボードからのペースト
  - テキスト入力
- **バリデーション**: インポートデータの構造と値の検証
- **エラー処理**: 不正なデータの検出と適切なエラーメッセージの表示

## 9. 認証システム（バックエンド連携版、AWS環境対応）

### 9.1 認証フロー

#### 9.1.1 認可コードフロー
1. **クライアント側**:
   - GoogleLogin コンポーネントに `flow="auth-code"` を設定
   - 環境に応じたリダイレクトURIを動的に生成
   - ユーザーがGoogleログインボタンをクリック
   - Googleの認証ダイアログを表示
   - ユーザーの同意後、認可コードを取得

2. **認可コード交換**:
   - クライアントが認可コードをバックエンドに送信
   - バックエンドがコードをアクセストークンとリフレッシュトークンと交換
   - バックエンドがセッションを生成し、HTTP-Onlyクッキーに保存

3. **認証状態確認**:
   - クライアントは環境に応じた `/auth/session` エンドポイントで認証状態を確認
   - セッションは自動的にクッキーで送信される
   - バックエンドはユーザー情報を返却

4. **ログアウト処理**:
   - クライアントが環境に応じた `/auth/logout` エンドポイントにリクエスト
   - バックエンドがセッションを破棄し、クッキーを無効化

#### 9.1.2 認証状態管理

- **セッション持続**: HTTP-Onlyクッキーによるセッション管理
- **状態同期**: コンポーネントマウント時とエラー発生時に自動的にセッションチェック
- **エラー処理**: 認証エラー（401）発生時のログイン画面への遷移
- **環境依存処理**: 
  - 開発環境と本番環境で異なるエンドポイントを自動的に使用
  - ローカル開発時と本番環境のエンドポイント形式の違いを吸収
  - プロキシ設定によるCORS問題の解決

### 9.2 認証UI

#### 9.2.1 ログインボタン
- **認可コードフロー対応Googleログインボタン**
  - `flow="auth-code"` 設定
  - ローディング状態表示（認証処理中の表示）
  - エラーメッセージ表示（認証失敗時）
  - アクセシビリティ対応（ラベルとARIA属性）

#### 9.2.2 ユーザープロフィール
- **ログイン済み状態の表示**
  - ユーザーアイコン（Google提供のプロフィール画像）
  - ユーザー名の表示
  - ログアウトボタン（バックエンドセッション終了処理）

### 9.3 認証エラーハンドリング
- **認証エラー検出**: 401/403レスポンスコードの検出
- **自動リダイレクト**: 認証エラー発生時のログイン画面への遷移
- **エラーメッセージ表示**: ユーザーフレンドリーなエラーメッセージの表示
- **認証リトライ**: 自動的な認証状態確認の実行

## 10. セキュリティ

### 10.1 データ保護
- **ローカルストレージ暗号化**: Base64+URIエンコーディングによる基本的な保護
- **認証情報管理**: HTTP-Onlyクッキーを使用した安全なセッション管理
- **HTTPS通信**: すべてのAPI通信でHTTPS使用
- **CSRF保護**: バックエンドでCSRF対策の実装

### 10.2 API連携
- **API Key管理**: 管理者APIキーの安全な管理（環境変数による設定）
- **レート制限対応**: API呼び出し頻度の制限と適切なエラーハンドリング
- **フォールバック機構**: API障害時の代替処理

### 10.3 エラー処理
- **エラーログ**: 詳細なエラー情報の記録（デバッグ用）
- **ユーザー通知**: ユーザーフレンドリーなエラーメッセージの表示
- **リカバリオプション**: データリセットやエラー復旧のための機能提供

## 11. 環境変数設定

### 11.1 環境変数一覧
- **`REACT_APP_MARKET_DATA_API_URL`**: 市場データAPIサーバーのベースURL（株価、為替、投資信託情報取得用、認証用）
- **`REACT_APP_API_STAGE`**: APIのステージ環境（'dev'、'prod'など）
- **`REACT_APP_ADMIN_API_KEY`**: 管理者API用認証キー
- **`REACT_APP_GOOGLE_CLIENT_ID`**: Google OAuth認証用クライアントID
- **`REACT_APP_DEFAULT_EXCHANGE_RATE`**: フォールバック用デフォルト為替レート

### 11.2 環境固有の設定ファイル
AWS環境への対応として、環境固有の設定ファイルを導入しました：

- **`.env.development`**: 開発環境用の環境変数設定
  ```
  REACT_APP_MARKET_DATA_API_URL=https://dev-api.example.com
  REACT_APP_API_STAGE=dev
  REACT_APP_GOOGLE_CLIENT_ID=your_dev_client_id.apps.googleusercontent.com
  REACT_APP_DEFAULT_EXCHANGE_RATE=150.0
  ```

- **`.env.production`**: 本番環境用の環境変数設定
  ```
  REACT_APP_MARKET_DATA_API_URL=https://api.example.com
  REACT_APP_API_STAGE=prod
  REACT_APP_GOOGLE_CLIENT_ID=your_prod_client_id.apps.googleusercontent.com
  REACT_APP_DEFAULT_EXCHANGE_RATE=150.0
  ```

### 11.3 環境判定ユーティリティ
`envUtils.js`に環境判定と環境依存値の取得機能を実装しています：

```javascript
// 環境判定関数
export const isDevEnvironment = () => {
  return process.env.NODE_ENV === 'development' || process.env.REACT_APP_API_STAGE === 'dev';
};

export const isProdEnvironment = () => {
  return process.env.NODE_ENV === 'production' && process.env.REACT_APP_API_STAGE === 'prod';
};

// 環境変数取得関数
export const getApiBaseUrl = () => {
  return process.env.REACT_APP_MARKET_DATA_API_URL || 'http://localhost:3000';
};

export const getApiStage = () => {
  return process.env.REACT_APP_API_STAGE || 'dev';
};

// APIエンドポイント構築関数
export const buildApiEndpoint = (path) => {
  const baseUrl = getApiBaseUrl();
  const stage = getApiStage();
  return `${baseUrl}/${stage}/${path}`;
};
```

## 12. 新規追加ユーティリティ

### 12.1 環境ユーティリティ (`envUtils.js`)
- **目的**: 環境依存の処理を抽象化し、コードの可読性と保守性を向上
- **主要機能**:
  - 実行環境の判定（開発環境、本番環境、ローカル開発環境）
  - 環境変数の取得と統一インターフェース提供
  - 環境に応じたAPIエンドポイントのURL生成
- **使用例**:
  ```javascript
  import { getApiBaseUrl, isDevEnvironment } from '../utils/envUtils';
  
  // 環境に応じた処理分岐
  const performOperation = () => {
    if (isDevEnvironment()) {
      console.log('開発環境固有の処理');
    } else {
      console.log('本番環境用の処理');
    }
  };
  
  // 環境に依存しないAPIエンドポイント構築
  const apiUrl = `${getApiBaseUrl()}/${getApiStage()}/api/market-data`;
  ```

### 12.2 API通信ユーティリティ (`apiUtils.js`)
- **目的**: API呼び出しの共通パターンを抽象化し、エラーハンドリングとリトライロジックを標準化
- **主要機能**:
  - リトライ機能付きのfetch関数
  - エラーレスポンスの標準化と整形
  - フォールバックデータの自動生成
  - AWS環境のAPI呼び出しに最適化
- **使用例**:
  ```javascript
  import { fetchWithRetry, formatErrorResponse } from '../utils/apiUtils';
  
  // リトライ機能付きAPI呼び出し
  const fetchData = async () => {
    try {
      const endpoint = buildApiEndpoint('api/market-data');
      const response = await fetchWithRetry(
        endpoint,
        'get',
        null,
        { type: 'us-stock', symbols: 'AAPL' },
        { withCredentials: true }
      );
      return response;
    } catch (error) {
      // エラーレスポンスの標準形式への変換
      return formatErrorResponse(error, 'AAPL');
    }
  };
  ```

### 12.3 Google Drive連携フック (`useGoogleDrive.js`)
- **目的**: Google Drive操作をカプセル化し、コンポーネントからの利用を簡素化
- **主要機能**:
  - ファイル一覧取得
  - ファイル保存
  - ファイル読み込み
  - ローディング状態管理
  - エラー状態管理
- **使用例**:
  ```javascript
  import { useGoogleDrive } from '../hooks/useGoogleDrive';
  
  const MyComponent = () => {
    const { listFiles, saveFile, loadFile, loading, error } = useGoogleDrive();
    
    const handleSave = async () => {
      const result = await saveFile(portfolioData);
      if (result) {
        console.log('保存成功:', result.name);
      }
    };
    
    return (
      <div>
        <button onClick={handleSave} disabled={loading}>
          {loading ? '保存中...' : 'Googleドライブに保存'}
        </button>
        {error && <p className="error">{error}</p>}
      </div>
    );
  };
  ```

## 改訂履歴

| バージョン | 日付 | 内容 | 担当者 |
|---|---|---|---|
| 1.0 | 2025/03/6 | 初版作成 |  |
| 2.0 | 2025/03/7 | jwt-decode対応、アクセシビリティ対応、プロキシ設定更新 |  |
| 3.0 | 2025/03/07 10:20 | Alpha Vantage API連携強化、環境変数名統一、マルチソースデータ取得フロー実装 |  |
| 3.4 | 2025/03/23 09:45 | Python依存をなくすためYahoo Finance APIをJavaScript実装に変更、Python yfinanceコードは残しつつ実際はyahoo-finance-proxyを使用、データソース名とフォールバック処理の更新 |  |
| 3.5 | 2025/03/27 18:00 | データソースをAlpaca API（米国株）、日本株スクレイピング、投資信託スクレイピングに変更、フォールバック処理の更新、デザインコンポーネントの追加 |  |
| 3.6 | 2025/03/28 14:00 | スクレイピングソース対応のインターフェース仕様の詳細化 |  |
| 3.7 | 2025/03/29 16:30 | 米国株スクレイピング機能の追加、データソース優先順位の更新 |  |
| 4.0 | 2025/03/30 12:30 | 入金シミュレーション機能の複数通貨対応（円/ドル）、購入株数表示機能を追加 |  |
| 5.0 | 2025/05/08 14:30 | AI分析機能の追加（ポートフォリオデータをAIアシスタントに分析させるプロンプト生成機能） |  |
| 6.0 | 2025/05/12 16:00 | リファクタリング - スクレイピング機能を削除し、単一市場データAPIサーバーに集約、環境変数名を`REACT_APP_MARKET_DATA_API_URL`に変更 | Claude |
| 6.1 | 2025/05/12 17:00 | Google認証のバックエンド連携対応を追加 - クライアントサイド完結型の認証から認可コードフローを用いたセキュアなバックエンド連携型認証システムへ移行 | Claude |
| 6.2 | 2025/05/20 17:30 | AWS環境対応 - 環境固有設定ファイルの導入、環境判定ユーティリティ、API通信共通化、リトライ機能強化、Google Drive連携の最適化 | Claude |
