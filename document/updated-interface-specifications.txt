# ポートフォリオマネージャー インターフェース仕様書（AI分析機能対応版）

**最終更新日時:** 2025/05/07 14:30

*本仕様書は、AIの別セッションでも開発を引き継げるよう設計されています。*

## 1. プロジェクト概要

「ポートフォリオマネージャー」は、資産管理を支援するWebアプリケーションです。ユーザーが保有資産と理想のポートフォリオ配分を比較・管理し、最適な資金配分のシミュレーションを実施できる環境を提供します。ブラウザのローカルストレージを活用したデータ永続化およびGoogleログインとGoogleドライブ連携機能を備え、複数デバイス間でのデータ共有をサポートします。

### 1.1 主要機能
- 資産管理（保有数の小数点以下4桁対応）
- 銘柄タイプ自動判定（個別株、ETF、インデックスファンド、投資信託など）
- 年間手数料率の自動推定と計算（個別株は0%固定、投資信託は信託報酬として表示）
- 年間配当金の計算と配当情報の管理
- 理想ポートフォリオ配分設定
- 複数通貨（円/ドル）対応の資金配分シミュレーション
- 購入可能株数の計算表示
- **AI分析機能（ポートフォリオデータをAIアシスタントに分析させるプロンプト生成）**（新規追加）
- データインポート/エクスポート
- ブラウザローカルストレージによるデータ永続化（URIエンコード+Base64による安全な暗号化）
- Google認証・Googleドライブ連携（Google Identity Services API対応）
- 市場データの自動取得（スクレイピングとマルチAPI連携）
  - 米国株：
    - プライマリ: Alpaca API
    - セカンダリ: Yahoo Finance API
    - 最終手段: 米国株スクレイピング（複数サイト）
  - 日本株： 
    - プライマリ: スクレイピング（複数サイト）
    - バックアップ: Yahoo Finance API
  - 投資信託：
    - プライマリ: スクレイピング（複数サイト）
    - バックアップ: Yahoo Finance API
- iOS風タブバーによるナビゲーション
- 自動消去機能付き通知システム
- エラーバウンダリによるアプリケーション耐障害性の向上

### 1.2 技術スタック
- **フロントエンド**: React.js 18.x
- **認証**: Google OAuth 2.0 (@react-oauth/google 0.11.0)
- **スタイリング**: Tailwind CSS 3.x
- **ステート管理**: React Context API
- **ルーティング**: React Router 6.x
- **データ可視化**: Recharts 2.x
- **API通信**: Axios 1.x, Fetch API
- **ユーティリティ**: Lodash 4.x, Day.js 1.x, jwt-decode 3.x
- **データ処理**: PapaParse 5.x (CSV処理)
- **UI拡張**: @headlessui/react 1.x
- **サーバーレス関数**: Netlify Functions
- **スクレイピング**: 
  - Cheerio 1.x (日本株・投資信託)
  - JSDOM 22.x (米国株・ETF)
- **デプロイ**: Netlify
- **データ永続化**: ローカルストレージ（URIエンコード+Base64暗号化）
- **クラウド連携**: Google Drive API v3
- **市場データ取得**: 
  - 米国株: Alpaca API（プライマリ）+ スクレイピング（最終手段）
  - 日本株: スクレイピング（複数サイト）
  - 投資信託: スクレイピング（複数サイト）
  - バックアップ: Yahoo Finance API
  - 為替レート: exchangerate.host

## 2. インターフェース構造

### 2.1 ページ構成
- **ダッシュボード** (`/`): 資産概要、グラフ、銘柄詳細
- **設定** (`/settings`): 銘柄追加、保有資産設定、目標配分設定、**AIプロンプト設定**（新規追加）
- **シミュレーション** (`/simulation`): 追加予算と購入シミュレーション（複数通貨対応、購入株数表示）、**AI分析プロンプト**（新規追加）
- **データ連携** (`/data`): インポート/エクスポート、データ同期、Googleドライブ連携

### 2.2 ナビゲーション
- 画面下部固定のiOS風タブナビゲーション
- 4つのタブ（ホーム、設定、シミュレーション、データ）
- アイコンとテキストの組み合わせUI
- アクティブタブの視覚的強調（青色ハイライト）
- セーフエリア対応（iPhoneのホームバーなど）

### 2.3 レイアウト構造
```
+----------------------------------------+
|              ヘッダー                  |
| (通貨切替、データ更新、ユーザープロフィール) |
+----------------------------------------+
|                                        |
|             メインコンテンツ             |
|                                        |
|                                        |
|                                        |
+----------------------------------------+
|             タブナビゲーション           |
| [ホーム] [設定] [シミュレーション] [データ] |
+----------------------------------------+
|         セーフエリア（ホームバー用）       |
+----------------------------------------+
```

### 2.4 エラーバウンダリ
- アプリケーション全体をエラーバウンダリでラップ
- 予期しないエラー発生時にアプリケーションのクラッシュを防止
- ユーザーフレンドリーなエラー表示画面
- リロードボタンによる復旧機能

### 2.5 通知システム
- 画面右下に固定表示される通知パネル
- 通知のタイプに応じた色分け表示
  - 成功：緑色背景
  - 警告：黄色背景
  - エラー：赤色背景
  - 情報：青色背景
- 自動消去機能付き
  - 情報、成功、警告通知：5秒後に自動消去
  - エラー通知：ユーザーによる手動消去が必要
- 各通知には手動で閉じるボタン（×）を表示
- 同時に複数の通知を表示可能
- スタック表示で新しい通知が下に追加される

### 2.6 データソース表示（スクレイピング対応版）
- 銘柄データのソースを明示的に表示
  - Alpaca：青色バッジ
  - 日本株スクレイピング（各ソース）：緑色バッジ
  - 投資信託スクレイピング（各ソース）：緑色バッジ
  - 米国株スクレイピング（各ソース）：紫色バッジ
  - Yahoo Finance：紫色バッジ
  - Fallback：黄色バッジ
- 更新時に各データソースの利用状況を通知
  - 例：「市場データを更新しました: 日本株スクレイピング: 3件 (Yahoo Finance Japan: 2件、Minkabu: 1件)、投資信託スクレイピング: 2件 (投資信託協会: 2件)、米国株スクレイピング: 2件 (Yahoo Finance: 1件、MarketWatch: 1件)、Alpaca: 3件」
- フォールバック使用時は注意喚起表示
- スクレイピングソースの詳細表示
  - 日本株・投資信託: Yahoo Finance Japan、Minkabu、Kabutan、投資信託協会、Morningstar
  - 米国株・ETF: Yahoo Finance、MarketWatch、Investing.com
- 株価情報の信頼性をユーザーが判断できるようサポート

## 3. 状態管理

### 3.1 コンテキスト設計
- **AuthContext**: 認証状態、ユーザー情報、Googleドライブ連携、PortfolioContextへの参照
- **PortfolioContext**: ポートフォリオデータ、資産情報、配当情報、シミュレーション計算、手数料管理、ローカルストレージ操作、**AIプロンプトテンプレート**（新規追加）

### 3.2 コンテキスト間の連携
- **ContextConnector**: AuthContextとPortfolioContextの相互参照を管理するコンポーネント
- **setPortfolioContextRef**: AuthContextがPortfolioContextへの参照を保持するための関数
- **handleAuthStateChange**: 認証状態変更時にPortfolioContextに通知するための関数

### 3.3 主要な状態変数
- `baseCurrency`: 基準通貨 ('JPY' | 'USD')
- `exchangeRate`: 為替レート情報 ({ rate, source, lastUpdated })
- `currentAssets`: 保有資産の配列（配当情報を含む）
- `targetPortfolio`: 目標配分の配列
- `additionalBudget`: 追加投資予算情報（金額と通貨）
- `aiPromptTemplate`: AI分析プロンプトのテンプレート（新規追加）
- `isAuthenticated`: 認証状態
- `user`: ユーザー情報
- `notifications`: 通知メッセージの配列
- `dataSource`: データソース ('local' | 'cloud')
- `lastSyncTime`: 最終同期時間
- `initialized`: 初期化完了フラグ
- `hasError`: エラー状態（エラーバウンダリ用）
- `totalAssets`: 総資産額
- `annualFees`: 年間手数料合計
- `annualDividends`: 年間配当金合計
- `scrapingStats`: スクレイピング統計情報

### 3.4 データ構造
#### 保有資産 (Asset)
```typescript
interface Asset {
  id: string;
  name: string;
  ticker: string;
  exchangeMarket: string;
  price: number;
  currency: string;
  holdings: number; // 小数点以下4桁対応
  annualFee: number; // 年間手数料率（%）- 個別株は常に0%
  fundType: string; // ファンドの種類 (ETF_JP, INDEX_US, STOCK など)
  isStock: boolean; // 個別株かどうかのフラグ
  isMutualFund: boolean; // 投資信託かどうかのフラグ
  feeSource: string; // 手数料情報の出所 ('個別株', '投資信託', 'ティッカー固有の情報', 'ファンドタイプからの推定', 'ユーザー設定')
  feeIsEstimated: boolean; // 手数料情報が推定値かどうか
  region?: string; // 対象地域 ('日本', '米国', 'グローバル', '不明')
  lastUpdated?: string;
  source?: string; // データソース名 ('Alpaca', 'Yahoo Finance Japan', 'Minkabu', 'Kabutan', '投資信託協会', 'Morningstar Japan', 'Yahoo Finance', 'Yahoo Finance Scraping', 'MarketWatch', 'Investing.com', 'Fallback')
  dividendYield: number; // 配当利回り（%）
  hasDividend: boolean; // 配当があるかどうか
  dividendFrequency: string; // 配当頻度（'monthly', 'quarterly', 'semi-annual', 'annual'）
  dividendIsEstimated: boolean; // 配当情報が推定値かどうか
  priceLabel?: string; // 価格表示ラベル ('株価' | '基準価額')
}
```

#### 追加予算
```typescript
interface BudgetInfo {
  amount: number;      // 金額
  currency: string;    // 通貨 ('JPY' | 'USD')
}

additionalBudget: BudgetInfo;
```

#### シミュレーション結果
```typescript
interface SimulationResult {
  ticker: string;         // 銘柄シンボル
  name: string;           // 銘柄名
  currentAllocation: number; // 現在の配分率（%）
  targetAllocation: number;  // 目標配分率（%）
  diff: number;           // 差分（%）
  currentValue: number;   // 現在の保有価値
  purchaseAmount: number; // 推奨購入金額
  purchaseShares: number; // 購入可能株数
  price: number;          // 現在の株価/基準価額
  currency: string;       // 通貨 ('JPY' | 'USD')
  isMutualFund: boolean;  // 投資信託かどうか
  source: string;         // データソース
}
```

#### AI分析用のデータ構造（新規追加）
```typescript
// AIプロンプトで使用する配分情報
interface AllocationItem {
  ticker: string;        // 銘柄シンボル
  name: string;          // 銘柄名
  percentage: number;    // 配分率（%）
}

// 現在のポートフォリオ配分
currentAllocation: AllocationItem[];

// 目標ポートフォリオ配分
targetAllocation: AllocationItem[];
```

#### スクレイピング統計情報
```typescript
interface ScrapingStats {
  japaneseStocks: {
    tried: number; // 試行回数
    succeeded: number; // 成功回数
    sources: {
      yahooJapan: number;
      minkabu: number;
      kabutan: number;
    }
  };
  mutualFunds: {
    tried: number; // 試行回数
    succeeded: number; // 成功回数
    sources: {
      yahooJapan: number;
      toushinLib: number;
      morningstar: number;
      minkabu: number;
    }
  };
  usStocks: {
    tried: number; // 試行回数
    succeeded: number; // 成功回数
    sources: {
      yahooFinance: number;
      marketWatch: number;
      investingCom: number;
    }
  }
}
```

#### 通知メッセージ
```typescript
interface Notification {
  id: number; // タイムスタンプをIDとして使用
  message: string; // 表示メッセージ
  type: 'info' | 'success' | 'warning' | 'error'; // 通知タイプ
}
```

#### ローカルストレージデータ
```typescript
interface StorageData {
  baseCurrency: string;
  exchangeRate: object;
  lastUpdated: string;
  currentAssets: Asset[];
  targetPortfolio: TargetAllocation[];
  additionalBudget: BudgetInfo;
  aiPromptTemplate: string; // AIプロンプトテンプレート（新規追加）
  version: string; // データバージョン管理用
  timestamp: string; // 保存日時
}
```

## 4. コンポーネント仕様

### 4.1 ダッシュボード画面コンポーネント
- **PortfolioSummary**: 総資産、銘柄数、年間手数料、年間配当金の表示
  - 最高/最低手数料率の銘柄を表示
  - 最高配当利回りの銘柄を表示
  - ファンドタイプ別の手数料統計を表示
  - ファンドタイプ別の配当金統計を表示
  - 投資信託の信託報酬を適切に表示
  - 手数料と配当についての説明を表示
- **PortfolioCharts**: 理想配分と現在配分の円グラフ
- **DifferenceChart**: 理想と現状の差分バーチャート
- **AssetsTable**: 保有資産の詳細テーブル
  - データソースと銘柄タイプの表示
  - 年間手数料の表示（個別株は0%、投資信託は信託報酬として表示）
  - 配当情報の表示（利回り、頻度、年間配当金）
  - 配当情報源のバッジ表示（推定値/確定値）
  - データソースのバッジ表示（スクレイピングソース別のバッジ）
  - 投資信託専用の表示（基準価額ラベル）
- **DataStatusBar**: データ更新状態と最終更新時刻の表示

### 4.2 設定画面コンポーネント
- **TickerSearch**: 銘柄検索と追加機能
  - 投資信託コードの自動認識と入力補助
- **PopularTickers**: 人気銘柄のワンクリック追加
  - インデックスファンド・ETFカテゴリ
  - 個別株カテゴリ
  - 日本市場カテゴリ
  - 投資信託カテゴリ
- **HoldingsEditor**: 保有資産の編集
  - 保有数量編集（小数点4桁対応）
  - 年間手数料率表示（個別株は編集不可）
  - 投資信託は信託報酬として表示
  - 銘柄タイプの表示
  - 手数料情報源を表示（個別株、投資信託、推定値、固有情報、ユーザー設定）
  - 配当情報の表示（利回り、頻度）
  - 配当情報源のバッジ表示
  - データソースのバッジ表示（スクレイピングソース別）
- **AllocationEditor**: 目標配分の編集
- **AiPromptSettings**: AIプロンプトテンプレートの設定（新規追加）
  - テンプレートの編集・カスタマイズ機能
  - デフォルトテンプレートへのリセット機能
  - プレースホルダー説明の表示
  - テンプレート保存機能
  - 使用方法の説明

### 4.3 シミュレーション画面コンポーネント
- **BudgetInput**: 追加予算の入力と予算プリセット
  - 直接入力と増減ボタン
  - 通貨選択機能（円/ドル）
  - 通貨ごとの予算プリセットボタン
    - 円: 10万、30万、50万、100万
    - ドル: 1000、3000、5000、10000
  - 通貨に応じた入力の検証（最小値、最大値）
  - 現在の基本通貨設定をデフォルト値として使用
  - アクセシビリティ対応済み（ラベルと入力フィールドの関連付け）
  
- **SimulationResult**: シミュレーション結果表示と購入機能
  - 各銘柄の現在配分と目標配分の表示
  - 推奨購入金額の表示
  - 購入可能株数の表示
  - 株価/基準価額の表示
  - 銘柄ごとの通貨表示
  - 自動的な通貨換算結果の表示
  - 為替レートの明示的な表示
  
- **AiAnalysisPrompt**: AI分析プロンプト生成（新規追加）
  - 現在のポートフォリオデータを元にしたプロンプト生成
  - クリップボードへのコピー機能
  - プロンプト全文/概要表示の切り替え機能
  - 使用方法の説明表示
  - 現在の通貨設定に応じたプロンプト生成（通貨に合わせた金額表示）
  - エラー処理（データ不足時の対応）

### 4.4 データ連携画面コンポーネント
- **ExportOptions**: データエクスポート機能
  - JSON/CSV形式選択
  - ファイルダウンロードとクリップボードコピー
  - アクセシビリティ対応済み（ラジオグループの適切な構造化）
- **ImportOptions**: データインポート機能
  - JSON/CSV形式選択
  - ファイル/クリップボード/テキスト入力による取り込み
  - アクセシビリティ対応済み
- **GoogleDriveIntegration**: Googleドライブ連携機能
  - ログイン状態表示
  - クラウド保存/読み込みボタン
  - データ同期ステータス表示
  - 同期ボタン
- **DataErrorRecovery**: データ修復機能
  - ローカルストレージのクリア機能
  - データリセット機能
  - エラー報告表示

### 4.5 共通コンポーネント
- **Header**: アプリヘッダー（通貨切替、更新ボタン）
- **TabNavigation**: iOS風タブナビゲーション
- **LoginButton**: Googleログインボタン
- **UserProfile**: ユーザープロフィール表示
- **ToastNotification**: 通知メッセージ表示
  - 自動消去タイマー機能（情報/成功/警告通知は5秒後に自動消去）
  - 手動消去ボタン
  - 通知タイプ別のスタイリング
- **DataSourceBadge**: データソース表示バッジ（スクレイピング対応版）
  - 各データソースに応じた表示（Alpaca、スクレイピングソース別、Yahoo Finance、Fallback）
  - ソースに応じた色分け
- **ErrorBoundary**: エラーバウンダリコンポーネント
  - エラー発生時の処理
  - リロード機能
  - エラー詳細表示

### 4.6 ユーティリティコンポーネント
- **FundTypeBadge**: ファンドタイプを表示するバッジ
- **FeeSourceBadge**: 手数料情報の出所を表示するバッジ
- **DividendBadge**: 配当情報を表示するバッジ
- **PriceDisplay**: 株価/基準価額を適切に表示するコンポーネント
- **ContextConnector**: コンテキスト間の連携を管理するコンポーネント

## 5. AI分析機能仕様（新規追加）

### 5.1 機能概要
- **目的**: ユーザーのポートフォリオデータをAIアシスタントに分析させるためのプロンプトを生成する
- **対応AIモデル**: Claude、ChatGPT、Geminiなど任意のAIアシスタント
- **分析内容**: 
  - 現在のポートフォリオ構成と理想構成の比較
  - 各銘柄の評価と見通し
  - ポートフォリオ全体のリスク分散、地域分散、セクター分散分析
  - 6ヶ月投資プランと継続投資戦略の提案

### 5.2 通貨対応
- **基本通貨連動**: アプリの表示通貨設定（円/ドル）に合わせてプロンプトを生成
  - アプリが円表示の場合: すべての金額を円ベースで計算・表示
  - アプリがドル表示の場合: すべての金額をドルベースで計算・表示
- **為替レート情報**: プロンプト内に現在の為替レート情報を含める
- **通貨変換**: 異なる通貨の資産を適切に変換して配分率を計算

### 5.3 プロンプト構成
- **初期情報**: 総資産額、毎月の投資予定額（対応する通貨表示）
- **現状配分**: 現在のポートフォリオ配分率（%）と銘柄名の一覧
- **目標配分**: 理想的なポートフォリオ配分率（%）と銘柄名の一覧
- **分析ガイドライン**: AIが実施すべき分析内容の詳細指示
- **出力フォーマット**: マークダウン形式での分析結果の構造指定
  - 個別銘柄分析表
  - ポートフォリオ全体評価
  - 具体的な投資プラン
  - 継続投資戦略

### 5.4 テンプレートカスタマイズ
- **カスタマイズ可能項目**: プロンプト全体の内容とフォーマット
- **プレースホルダー**: 実際のデータに置き換えられる変数
  - `{totalAssets}`: 総資産額
  - `{baseCurrency}`: 基本通貨
  - `{monthlyBudget}`: 毎月の投資予定額
  - `{budgetCurrency}`: 予算通貨
  - `{currentAllocation}`: 現在のポートフォリオ配分
  - `{targetAllocation}`: 目標ポートフォリオ配分
- **保存機能**: カスタマイズしたテンプレートをローカルストレージに保存
- **リセット機能**: デフォルトテンプレートに戻す機能

### 5.5 使用フロー
1. シミュレーションタブでAI分析プロンプトセクションを確認
2. 「プロンプトをコピー」ボタンをクリックしてクリップボードにコピー
3. 任意のAIアシスタント（Claude、ChatGPT、Geminiなど）を開く
4. クリップボードの内容を貼り付けて送信
5. AIが自動的にポートフォリオの分析と提案を実行

### 5.6 エラーハンドリング
- **データ不足時**: 適切なメッセージを表示（「保有資産がありません」など）
- **ゼロ配分時**: エラーメッセージではなく情報メッセージを表示
- **通貨変換エラー**: デフォルト値（150.0）を使用して計算を継続

## 6〜15. （既存の内容と同じ - 省略）

## 改訂履歴

| バージョン | 日付 | 内容 | 担当者 |
|---|---|---|---|
| 1.0 | 2025/03/6 | 初版作成 |  |
| 2.0 | 2025/03/7 | jwt-decode対応、アクセシビリティ対応、プロキシ設定更新 |  |
| 3.0 | 2025/03/07 10:20 | Alpha Vantage API連携強化、環境変数名統一、マルチソースデータ取得フロー実装 |  |
| 3.4 | 2025/03/23 09:45 | Python依存をなくすためYahoo Finance APIをJavaScript実装に変更、Python yfinanceコードは残しつつ実際はyahoo-finance-proxyを使用、データソース名とフォールバック処理の更新 |  |
| 3.5 | 2025/03/27 18:00 | データソースをAlpaca API（米国株）、日本株スクレイピング、投資信託スクレイピングに変更、フォールバック処理の更新、デザインコンポーネントの追加 |  |
| 3.6 | 2025/03/28 14:00 | スクレイピングソース対応のインターフェース仕様の詳細化。スクレイピング統計情報データ構造の追加。データソースバッジのスクレイピングソース対応。スクレイピング特有のエラー処理追加。 |  |
| 3.7 | 2025/03/29 16:30 | 米国株スクレイピング機能の追加。データソース優先順位の更新。ユーザーインターフェースのデータソースバッジとスタイルの更新。マルチソースフローの更新。スクレイピング統計情報のデータ構造更新。|  |
| 4.0 | 2025/03/30 12:30 | 入金シミュレーション機能の複数通貨対応（円/ドル）、購入株数表示機能を追加。BudgetInputコンポーネントとSimulationResultコンポーネントの更新。通貨換算処理とシミュレーション計算処理の更新。 |  |
| 5.0 | 2025/05/07 14:30 | AI分析機能の追加（ポートフォリオデータをAIアシスタントに分析させるプロンプト生成機能）。AIプロンプトテンプレート設定とカスタマイズ機能。現在の通貨設定に連動したプロンプト生成機能。 |  |
