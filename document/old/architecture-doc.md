# ポートフォリオマネージャー アーキテクチャ設計書

**文書バージョン:** 1.0  
**最終更新日:** 2025/03/16

## 1. システム概要

### 1.1 目的

ポートフォリオマネージャーは、ユーザーが保有資産と理想のポートフォリオ配分を比較・管理し、最適な資金配分をシミュレーションできる資産管理ウェブアプリケーションです。モバイルフレンドリーなUIと多様なデータソースからの市場情報取得により、投資判断を支援します。

### 1.2 主要機能
- 保有資産管理（小数点以下4桁対応）
- 理想ポートフォリオ配分設定
- 追加投資シミュレーション
- 市場データ自動取得
- データインポート/エクスポート
- Google認証とデータ同期

### 1.3 ユーザープロファイル
- 個人投資家（株式・投資信託・暗号資産など）
- ポートフォリオ管理を行う金融アドバイザー
- 資産配分を最適化したい投資初心者

## 2. アーキテクチャ原則

### 2.1 設計原則
- **クライアントサイド中心**: 主要ロジックはフロントエンドで実行
- **サーバーレスアーキテクチャ**: バックエンドはNetlify Functionsで実装
- **コンポーネントベース**: 再利用可能なUIコンポーネント設計
- **ステート分離**: 認証とポートフォリオデータの状態管理を分離
- **多層データ取得**: 複数のデータソースと堅牢なフォールバック機構
- **プログレッシブウェブアプリ(PWA)指向**: モバイル最適化とオフライン機能

### 2.2 技術選定理由
- **React**: コンポーネントベースUIと豊富なエコシステム
- **Context API**: Reduxより軽量で十分な状態管理機能
- **Tailwind CSS**: 迅速なUI開発と一貫したスタイリング
- **Netlify**: サーバーレスデプロイと関数実行環境の簡素化
- **Google OAuth**: セキュアな認証と追加API連携の容易さ

## 3. システムアーキテクチャ

### 3.1 全体構成図

```
+-------------------------------------------------+
|                クライアント層                     |
|   +-------------------+    +----------------+   |
|   |  React Components |    |   Context API  |   |
|   +-------------------+    +----------------+   |
|             |                      |            |
|   +-------------------+    +----------------+   |
|   |   Service Layer   |    |  Hooks & Utils |   |
|   +-------------------+    +----------------+   |
+--------------------|---------------------------+
                     |
+--------------------v----------------------------+
|                  API層                          |
|   +-------------------+    +----------------+   |
|   | Netlify Functions |    | Auth Services  |   |
|   +-------------------+    +----------------+   |
+--------------------|---------------------------+
                     |
+--------------------v----------------------------+
|                外部サービス層                    |
|  +----------+  +--------+  +-----------------+  |
|  |  Yahoo   |  | Alpha  |  | Google Services |  |
|  | Finance  |  |Vantage |  | (OAuth, Drive)  |  |
|  +----------+  +--------+  +-----------------+  |
+-------------------------------------------------+
```

### 3.2 論理アーキテクチャ

```
+-----------------------------------+
|         プレゼンテーション層        |
|  (UI Components, Pages, Layouts)  |
+-----------------------------------+
                  |
+-----------------------------------+
|             アプリケーション層      |
|     (Context Providers, Hooks)    |
+-----------------------------------+
                  |
+-----------------------------------+
|              サービス層            |
|  (API Services, Market Data Svc)  |
+-----------------------------------+
                  |
+-----------------------------------+
|               データ層             |
| (LocalStorage, API Interactions)  |
+-----------------------------------+
```

## 4. フロントエンドアーキテクチャ

### 4.1 コンポーネント構造

コンポーネントは以下の階層に分類されます：

1. **ページコンポーネント**: 各画面の基本構造を定義
2. **機能コンポーネント**: 特定機能を担当するUI要素
3. **共通コンポーネント**: 複数箇所で再利用されるUI要素
4. **レイアウトコンポーネント**: ページの構造を定義

```
App
├── Providers (Context Providers)
│   ├── AuthProvider
│   └── PortfolioProvider
├── Layouts
│   ├── Header
│   └── TabNavigation
├── Pages
│   ├── Dashboard
│   ├── Settings
│   ├── Simulation
│   └── DataIntegration
└── Common Components
    ├── UI Elements
    ├── Data Display
    └── Notifications
```

### 4.2 状態管理アーキテクチャ

React Context APIを用いた2つの主要コンテキストで状態を管理します：

1. **AuthContext**: 認証関連の状態管理
   - ユーザー認証状態
   - ログイン/ログアウト処理
   - Googleドライブ連携機能

2. **PortfolioContext**: ポートフォリオデータ管理
   - 保有資産情報
   - 目標配分設定
   - 市場データ取得機能
   - シミュレーション計算
   - 通知管理

```
+-----------------------------------------------------+
|                  Application State                   |
+-----------------------------------------------------+
|                         |                           |
|                         |                           |
v                         v                           v
+----------------+  +----------------+  +------------------------+
|  Auth State    |  | Portfolio Data |  | UI/Interaction State  |
|  (AuthContext) |  | (Portfolio     |  | (Component Level)     |
|                |  |  Context)      |  |                       |
+----------------+  +----------------+  +------------------------+
```

### 4.3 データフローアーキテクチャ

1. **単方向データフロー**
   - コンテキスト → コンポーネント
   - ユーザー操作 → コンテキスト更新関数 → 状態更新 → 再レンダリング

2. **サービス連携**
   - コンテキスト内のメソッド → サービス呼び出し → 外部API → データ更新

```
+-------------+    +-------------+    +-------------+
| User Action | -> | Context API | -> | Components  |
+-------------+    +-------------+    +-------------+
                         |
                         v
                   +-------------+
                   | Services    |
                   +-------------+
                         |
                         v
                   +-------------+
                   | External API|
                   +-------------+
```

## 5. サーバーレスアーキテクチャ（Netlify Functions）

### 5.1 機能構成

Netlify Functionsを使用して、以下のAPIプロキシを実装：

1. **yahoo-finance-proxy.js**: 株価・為替データ取得
2. **alpha-vantage-proxy.js**: 代替市場データ取得
3. **mof-exchange-rate-proxy.js**: 財務省為替レート取得（代替）

```
+-------------------+        +------------------+
| Client App        |  --->  | Netlify Function |
| (Browser)         |  <---  | (Serverless)     |
+-------------------+        +------------------+
                                      |
                                      v
                              +------------------+
                              | External API     |
                              | (Yahoo Finance,  |
                              |  Alpha Vantage)  |
                              +------------------+
```

### 5.2 API連携設計

1. **リクエスト処理フロー**
   - クライアントリクエスト → Netlify Function
   - API呼び出し（プロキシ）
   - レスポンス整形 → クライアント返却

2. **エラー処理**
   - 階層的フォールバックメカニズム
   - 複数データソース間での切り替え
   - エラーメッセージのクライアント伝達

3. **CORS対応**
   - すべてのレスポンスにCORSヘッダー付与
   - プリフライトリクエスト処理

## 6. 認証アーキテクチャ

### 6.1 Google OAuth 2.0フロー

```
+-------------+    +-------------+    +-------------+    +-------------+
| User        | -> | Application | -> | Google      | -> | Redirect    |
| (Browser)   |    | Login UI    |    | Auth Server |    | w/ Token    |
+-------------+    +-------------+    +-------------+    +-------------+
                                                              |
                                                              v
                                                         +-------------+
                                                         | Token       |
                                                         | Verification|
                                                         +-------------+
                                                              |
                                                              v
                                                         +-------------+
                                                         | Auth State  |
                                                         | Context     |
                                                         +-------------+
```

### 6.2 トークン管理

1. **保存**: ブラウザのlocalStorageに保存
2. **有効期限**: トークン読み込み時に検証
3. **更新メカニズム**: 期限切れ時の再認証促進

## 7. データアーキテクチャ

### 7.1 データモデル

#### 7.1.1 Asset（保有資産）
```json
{
  "id": "String",
  "name": "String",
  "ticker": "String",
  "exchangeMarket": "String",
  "price": "Number",
  "currency": "String",
  "holdings": "Number",
  "annualFee": "Number",
  "lastUpdated": "ISODateString",
  "source": "String"
}
```

#### 7.1.2 TargetAllocation（目標配分）
```json
{
  "id": "String",
  "ticker": "String",
  "name": "String",
  "targetPercentage": "Number"
}
```

#### 7.1.3 PortfolioData（ポートフォリオデータ）
```json
{
  "baseCurrency": "String",
  "exchangeRate": {
    "rate": "Number",
    "source": "String",
    "lastUpdated": "ISODateString"
  },
  "lastUpdated": "ISODateString",
  "currentAssets": ["Asset"],
  "targetPortfolio": ["TargetAllocation"]
}
```

### 7.2 データ永続化

1. **エクスポート/インポート**: JSON/CSV形式
2. **ローカルストレージ**: 将来的に実装予定
3. **Googleドライブ**: 認証ユーザー向けストレージ
4. **シリアライズ/デシリアライズ**: 標準JSON形式

### 7.3 データ同期戦略

1. **オンデマンド同期**: ユーザー操作による明示的な同期
2. **フォールバックデータ**: ネットワーク問題時のデータ提供
3. **競合解決**: 最終更新日時に基づく単純解決

## 8. UIアーキテクチャ

### 8.1 レイアウト構造

```
+------------------------------------------+
|                Header                    |
+------------------------------------------+
|                                          |
|                                          |
|             Content Area                 |
|                                          |
|                                          |
|                                          |
+------------------------------------------+
|              Tab Navigation              |
+------------------------------------------+
```

### 8.2 レスポンシブ設計

Tailwind CSSブレークポイントに基づく適応的レイアウト：
- **sm**: 640px以上
- **md**: 768px以上
- **lg**: 1024px以上
- **xl**: 1280px以上

### 8.3 アクセシビリティ考慮事項

- 意味的なHTML構造
- キーボードナビゲーション
- 十分なカラーコントラスト
- スクリーンリーダー対応

## 9. エラー処理アーキテクチャ

### 9.1 エラー階層

```
+--------------------+
| Application Errors |
+--------------------+
         |
         |
+-------------------+    +-------------------+
| Network Errors    |    | Business Logic    |
| - API Timeouts    |    | Errors            |
| - Connection Loss |    | - Validation      |
+-------------------+    | - Calculations    |
                         +-------------------+
         |                        |
         v                        v
+-------------------+    +-------------------+
| Recovery Strategy |    | User Notification |
+-------------------+    +-------------------+
```

### 9.2 リカバリメカニズム

1. **再試行**: API呼び出し失敗時の自動再試行
2. **代替データソース**: プライマリAPI失敗時の別ソース使用
3. **デフォルト値**: すべての取得方法失敗時のフォールバック
4. **部分的更新**: 一部データのみ取得成功時の部分更新

### 9.3 エラー通知

- **視覚的通知**: ステータスバー、トースト通知
- **インライン表示**: 該当コンポーネント内の表示
- **アクション提案**: 問題解決のためのユーザーアクション提示

## 10. セキュリティアーキテクチャ

### 10.1 認証と認可

- **OAuth 2.0**: Google認証による安全なログイン
- **JWT検証**: トークンの署名と有効期限の検証
- **アクセス制限**: 認証状態に基づいた機能アクセス制御

### 10.2 データ保護

- **クライアントサイド保管**: 機密データの最小化
- **環境変数**: API鍵などの秘密情報保護
- **サードパーティアクセス制限**: 必要最小限のスコープ

## 11. パフォーマンス最適化

### 11.1 最適化戦略

1. **React最適化**
   - メモ化（React.memo, useMemo, useCallback）
   - コンポーネント分割による再レンダリング最小化
   - 状態更新バッチ処理

2. **ネットワーク最適化**
   - APIレスポンスのキャッシュ
   - 必要時のみのデータ取得
   - バックグラウンド更新

3. **レンダリング最適化**
   - コード分割（React.lazy, Suspense）
   - 画像最適化
   - CSSの効率的適用

### 11.2 パフォーマンス目標

- **初期読み込み**: 2秒以内（中速モバイル接続）
- **インタラクション応答**: 100ms以内
- **データ更新完了**: 3秒以内

## 12. スケーラビリティ考慮事項

### 12.1 クライアントサイドスケーラビリティ

- **データ量の増加**: 大量銘柄時のパフォーマンス維持
- **コンポーネント再利用**: 新機能追加時の拡張性
- **状態管理分離**: 機能ごとの独立した状態管理

### 12.2 サーバーレス関数スケーラビリティ

- **API制限管理**: レート制限の動的対応
- **キャッシュ戦略**: 共通データのキャッシュ
- **同時リクエスト**: 複数ユーザーアクセス時の対応

## 13. デプロイアーキテクチャ

### 13.1 CI/CD パイプライン

```
+----------+    +---------+    +----------+    +----------+
| Git Push | -> | Build   | -> | Testing  | -> | Netlify  |
|          |    | Process |    | (Future) |    | Deploy   |
+----------+    +---------+    +----------+    +----------+
```

### 13.2 環境分離

- **開発環境**: ローカル開発サーバー
- **ステージング環境**: プレビューデプロイメント
- **本番環境**: 本番サイトデプロイメント

### 13.3 設定管理

- **.env.local**: ローカル開発用環境変数
- **Netlify環境変数**: 本番環境用設定
- **netlify.toml**: デプロイ設定と環境ごとのルール

## 14. 監視とロギング

### 14.1 クライアントサイド監視

- **エラー追跡**: コンソールエラーとエラーバウンダリー
- **パフォーマンス測定**: ユーザー体験メトリクス
- **ユーザー行動分析**: 将来的な実装予定

### 14.2 サーバーレス関数監視

- **Netlifyログ**: 関数実行とエラーログ
- **API連携状態**: 外部サービス連携成功率
- **レスポンスタイム**: API応答時間の追跡

## 15. テスト戦略

### 15.1 テスト階層

1. **単体テスト**: 個別関数・ユーティリティ
2. **コンポーネントテスト**: 分離されたUIコンポーネント
3. **統合テスト**: コンテキストと連携したコンポーネント
4. **E2Eテスト**: ユーザーフロー全体

### 15.2 テスト自動化（将来計画）

- **Jest**: JavaScript単体テスト
- **React Testing Library**: コンポーネントテスト
- **Cypress**: E2Eテスト

## 16. 拡張性と進化

### 16.1 将来的な拡張領域

1. **データ永続化強化**
   - ローカルデータベース（IndexedDB）
   - リアルタイム同期機能

2. **機能拡張**
   - ポートフォリオ履歴追跡
   - 複数ポートフォリオ管理
   - パフォーマンス分析ツール

3. **インテグレーション**
   - 証券会社API連携
   - マーケットニュース統合
   - 税務計算機能

### 16.2 技術的デットの管理

- **定期的なコード品質レビュー**
- **モジュール分割とリファクタリング計画**
- **拡張ポイントの明示的ドキュメント化**

## 17. ドキュメント戦略

- **アーキテクチャドキュメント**: システム設計の包括的説明
- **コンポーネントカタログ**: UIコンポーネントのドキュメント
- **API仕様**: 内部・外部API連携の仕様
- **開発者ガイド**: セットアップと開発手順

## 付録

### A. 技術スタック詳細

| カテゴリ | 技術 | バージョン |
|---------|------|-----------|
| フロントエンドフレームワーク | React | 18.x |
| ルーティング | React Router | 6.x |
| スタイリング | Tailwind CSS | 3.x |
| 状態管理 | React Context API | - |
| 認証 | @react-oauth/google | 0.11.x |
| HTTP通信 | Axios | 1.x |
| 可視化 | Recharts | 2.x |
| ユーティリティ | Lodash, Day.js | 4.x, 1.x |
| ビルドツール | Create React App | 5.x |
| デプロイ | Netlify | - |

### B. システム制約

1. **クライアントサイドのみ**
   - すべての計算はクライアントで実行
   - データ永続化は限定的

2. **API依存**
   - 外部APIの可用性に依存
   - レート制限の影響を受ける

3. **ブラウザ互換性**
   - モダンブラウザのみサポート
   - IE11は非サポート

### C. リファレンスアーキテクチャ

- React Context APIパターン
- JAMstack
- Serverless Architecture
- Progressive Web App
